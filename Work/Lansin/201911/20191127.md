# 20191127

精技雅虎購物中心後台欄位頁面ok

上傳部分 大致上都OK 了 差 圖片 影片 跟 HTML ， 然後才能在處理真的上架API 的時候的狀況 ， 我先把12月2號前要弄得EPSON需求單先處理

{% embed url="https://dotblogs.com.tw/yc421206/archive/2008/11/30/6130.aspx" %}

```text
Imports System.IO
Imports System.Net
Imports Newtonsoft.Json
Imports Newtonsoft.Json.Linq
Imports YahooShoppingSCM_API
Imports System.Linq
Imports System.Threading.Tasks

Public Class AmazonUploadFile

    Private Const _credentialUrl As String = "https://tw.buy.yahoo.com/api/fileUploader/v1/credentials"
    Private Const _putObjectUrl As String = "http://v3.eclifeapi.com.tw/api/Bucket/PutObject"
    Private Const _fileObjectUrl As String = "https://tw.buy.yahoo.com/api/fileUploader/v1/fileObjects/"

    ''' <summary>
    ''' yahoo 要求的加密格式
    ''' </summary>
    Enum ServerSideEncryptionList
        None
        AES256
        AWSKMS
    End Enum

    ''' <summary>
    ''' AWS伺服器位址
    ''' </summary>
    Enum RegionEndpointsList
        'The US East (Virginia) endpoint.
        USEast1
        '///
        '/// Summary:
        '///     The Middle East (Bahrain) endpoint.
        MESouth1
        '///
        '/// Summary:
        '///     The Canada (Central) endpoint.
        CACentral1
        '//
        '/// Summary:
        '//     The China (Ningxia) endpoint.
        CNNorthWest1
        '//
        '/// Summary:
        '//     The China (Beijing) endpoint.
        CNNorth1
        '//
        '/// Summary:
        '//     The US GovCloud West (Oregon) endpoint.
        USGovCloudWest1
        '//
        '/// Summary:
        '//     The US GovCloud East (Virginia) endpoint.
        USGovCloudEast1
        '//
        '/// Summary:
        '//     The South America (Sao Paulo) endpoint.
        SAEast1
        '//
        '/// Summary:
        '//     The Asia Pacific (Singapore) endpoint.
        APSoutheast1
        '//
        '/// Summary:
        '//     The Asia Pacific (Mumbai) endpoint.
        APSouth1
        '//
        '/// Summary:
        '//     The Asia Pacific (Osaka-Local) endpoint.
        APNortheast3
        '//
        '/// Summary:
        '//     The Asia Pacific (Sydney) endpoint.
        APSoutheast2
        '//
        '/// Summary:
        '//     The Asia Pacific (Tokyo) endpoint.
        APNortheast1
        '//
        '/// Summary:
        '//     The US East (Ohio) endpoint.
        USEast2
        '//
        '/// Summary:
        '//     The Asia Pacific (Seoul) endpoint.
        APNortheast2
        '//
        '/// Summary:
        '//     The US West (Oregon) endpoint.
        USWest2
        '//
        '/// Summary:
        '//     The EU North (Stockholm) endpoint.
        EUNorth1
        '//
        '/// Summary:
        '//     The EU West (Ireland) endpoint.
        EUWest1
        '//
        '/// Summary:
        '//     The US West (N. California) endpoint.
        USWest1
        '//
        '/// Summary:
        '//     The EU West (Paris) endpoint.
        EUWest3
        '//
        '/// Summary:
        '//     The EU Central (Frankfurt) endpoint.
        EUCentral1
        '//
        '/// Summary:
        '//     The Asia Pacific (Hong Kong) endpoint.
        APEast1
        '//
        '/// Summary:
        '//     The EU West (London) endpoint.
        EUWest2
    End Enum

    ''' <summary>
    ''' 上傳AWS API資料格式
    ''' </summary>
    Public Class PutObjectModel
        Public Property AwsAccessKeyId As String
        Public Property AwsSecretAccessKey As String
        Public Property AwsSessionToken As String
        Public Property BucketName As String
        Public Property FileUrl As String
        Public Property FileUploadPath As String
        Public Property Metadata As Dictionary(Of String, String) = New Dictionary(Of String, String)
        Public Property SideEncryption As ServerSideEncryptionList
        Public Property RegionEndpoint As RegionEndpointsList
    End Class

    ''' <summary>
    ''' AWS 檔案位址
    ''' </summary>
    Public Class FileObjectsModel
        <Diagnostics.CodeAnalysis.SuppressMessage("Style", "IDE1006:Naming Styles", Justification:="<Pending>")>
        Public Property id As String
        <Diagnostics.CodeAnalysis.SuppressMessage("Style", "IDE1006:Naming Styles", Justification:="<Pending>")>
        Public Property url As String
        <Diagnostics.CodeAnalysis.SuppressMessage("Style", "IDE1006:Naming Styles", Justification:="<Pending>")>
        Public Property expiredTs As DateTime
    End Class

    '''' <summary>
    '''' Yahoo登入後的憑證
    '''' </summary>
    'Public Class YahooRequestData
    '    Public Property Cookies As CookieCollection
    '    Public Property WSSID As String
    'End Class

    'Private Shared _YahooResquestData As YahooRequestData = Nothing
    'Public Shared Property YahooResquestData As YahooRequestData
    '    Get
    '        If _YahooResquestData Is Nothing Then
    '            _YahooResquestData = New YahooRequestData With {
    '                .Cookies = Get_YSSCM_CookieCollection()
    '            }
    '            _YahooResquestData.WSSID = Get_YSSCM_WSSID_token(_YahooResquestData.Cookies)
    '        End If

    '        Return _YahooResquestData
    '    End Get
    '    Set
    '    End Set
    'End Property

    ''' <summary>
    ''' 上傳檔案至AWS並取回檔案Url
    ''' </summary>
    ''' <param name="url"></param>
    ''' <param name="fileName"></param>
    ''' <returns></returns>
    Public Function GenAWSUrlByUrl(url As String, fileName As String, wssid As String, cookie As CookieCollection) As FileObjectsModel
        Dim cookieCollection As CookieCollection = cookie
        Dim mWSSID As String = wssid
        Dim headerDic = New Dictionary(Of String, String) From {
            {"X-YahooWSSID-Authorization", mWSSID}
        }
        Dim credentials As String = SendRequest("GET", _credentialUrl, "", cookieCollection, headerDic)
        Dim Obj As JObject = JsonConvert.DeserializeObject(credentials)
        Dim id As String = Obj.Item("id").ToString
        Dim key As String = Obj.Item("key").ToString
        Dim token As String = Obj.Item("token").ToString
        Dim putObject As PutObjectModel = New PutObjectModel With {
            .AwsAccessKeyId = id,
            .AwsSecretAccessKey = key,
            .AwsSessionToken = token,
            .BucketName = "ytw-shp-file-uploader",
            .FileUrl = url,
            .FileUploadPath = "FileUploader/" + fileName,
            .SideEncryption = ServerSideEncryptionList.AES256,
            .RegionEndpoint = RegionEndpointsList.APNortheast1
        }
        putObject.Metadata.Add("YahooWSSID-Authorization", mWSSID)
        Dim etag As String = UploadFile(putObject)
        Dim fileObject As FileObjectsModel = GetFileObje(etag, cookieCollection, headerDic)
        Return fileObject
    End Function

    ''' <summary>
    ''' 上傳檔案至 Amazon S3 回傳 etag
    ''' </summary>
    ''' <param name="putObject"></param>
    ''' <returns></returns>
    Public Function UploadFile(putObject As PutObjectModel) As String
        Dim request As HttpWebRequest = WebRequest.Create(_putObjectUrl)
        request.Method = "POST"
        request.ContentType = "application/json"
        '禁止轉址
        request.AllowAutoRedirect = False
        Dim JSONobj As String = JsonConvert.SerializeObject(putObject)
        '內容轉為資料流
        If JSONobj <> "" Or JSONobj <> Nothing Then
            Dim st As Stream = request.GetRequestStream()
            Dim byteArray As Byte() = Encoding.Default.GetBytes(JSONobj)
            st.Write(byteArray, 0, byteArray.Length)
        End If

        Try
            Using response As HttpWebResponse = CType(request.GetResponse(), HttpWebResponse)
                '回傳資料解碼
                Using reader = New StreamReader(response.GetResponseStream(), Encoding.UTF8)
                    Dim responseText As String = reader.ReadToEnd()
                    '回傳API JObject
                    Dim etag = JsonConvert.DeserializeObject(responseText).Item("data").Item("eTag").ToString
                    Return etag
                End Using
            End Using
        Catch ex As Exception
            Throw New Exception(ex.Message)
        End Try
    End Function

    ''' <summary>
    ''' 取回Amazon S3上的檔案資訊
    ''' </summary>
    ''' <param name="eTag"></param>
    ''' <param name="cookieCollection"></param>
    ''' <returns></returns>
    Public Function GetFileObje(eTag As String, cookieCollection As CookieCollection, headers As Dictionary(Of String, String)) As FileObjectsModel
        If Not String.IsNullOrWhiteSpace(eTag) Then
            'etag要清除"符號
            Dim objUrl As String = _fileObjectUrl + eTag.Trim(Chr(34))
            '查詢檔案url如果取得失敗最多重複10次，因為檔案上傳後，雖然可以取得etag但是還無法立即搜尋到
            Dim max As Integer = 10
            For index As Integer = 1 To max
                Try
                    Dim awsfileObjectStr As String = SendRequest("GET", objUrl, "", cookieCollection, headers)
                    Dim fileObjectData As FileObjectsModel = JsonConvert.DeserializeObject(Of FileObjectsModel)(awsfileObjectStr)
                    Return fileObjectData
                Catch ex As Exception
                    If index <> max Then
                        Task.Delay(500)
                    Else
                        Throw New Exception(ex.Message)
                    End If
                End Try
            Next
            Throw New Exception("eTag無效")
        Else
            Throw New Exception("eTag無效")
        End If
    End Function

    Public Function ModifyHtmlImgUrl(text As String, wssid As String, cookie As CookieCollection) As String
        Dim instance As New Regex("(?<=<img.+?src="")(?<imgsrc>.+?)(?="")")
        Dim match As MatchCollection = instance.Matches(text)
        For Each item As Match In match
            Dim res As FileObjectsModel = GenAWSUrlByUrl(item.Value, Path.GetFileName(item.Value), wssid, cookie)
            If res IsNot Nothing And Not String.IsNullOrWhiteSpace(res.url) Then
                text = Regex.Replace(text, item.Value, res.url)
            End If
        Next
        Return text
    End Function

    ''' <summary>
    ''' 發送Api請求
    ''' </summary>
    ''' <param name="Method"></param>
    ''' <param name="URL"></param>
    ''' <param name="JSONString"></param>
    ''' <param name="cookieCollection"></param>
    ''' <returns></returns>
    Public Function SendRequest(Method As String, URL As String, JSONString As String, cookieCollection As CookieCollection, headers As Dictionary(Of String, String)) As String
        '取得雅虎購物中心驗證cookie與wssid
        '***** 將cookie與wssid塞入封包 *****
        '實作 HttpWebRequest
        Dim request As HttpWebRequest = WebRequest.Create(URL) '丟入函數的URL參數
        request.CookieContainer = New CookieContainer()
        request.CookieContainer.Add(cookieCollection)

        If headers IsNot Nothing Then
            For Each header As KeyValuePair(Of String, String) In headers
                request.Headers.Add(header.Key, header.Value)
            Next
        End If
        'request.Headers.Add("X-YahooWSSID-Authorization", wssid)
        request.Method = Method '丟入函數的Method參數
        '禁止轉址
        request.AllowAutoRedirect = False
        '內容轉為資料流
        If JSONString <> "" Or JSONString <> Nothing Then
            Dim st As Stream = request.GetRequestStream()
            Dim byteArray As Byte() = Encoding.Default.GetBytes(JSONString)
            st.Write(byteArray, 0, byteArray.Length)
        End If
        '執行HttpWebRequest
        Try
            Using response As HttpWebResponse = CType(request.GetResponse(), HttpWebResponse)
                '回傳資料解碼
                Using reader = New StreamReader(response.GetResponseStream(), Encoding.UTF8)
                    Dim responseText As String = reader.ReadToEnd()
                    '回傳API JObject
                    Return responseText
                End Using
            End Using
        Catch ex As Exception
            Throw New Exception(ex.Message)
        End Try
    End Function
End Class

```

```text
If InStr(1, a, ".", 1) = 0 Then
            a = Str(a) + ".00"
        Else
            a = Math.Round(Int(a), 2)
        End If
        
        
         If StrComp(ecdt.Select().FirstOrDefault.Item("SpicalPrice").ToString, ".") = -1 Then
                        .price = ecdt.Select().FirstOrDefault.Item("SpicalPrice").ToString + ".00"
                    Else
                        .price = ecdt.Select().FirstOrDefault.Item("SpicalPrice").ToString
                    End If
                    
                    
                      If InStr(1, ecdt.Select().FirstOrDefault.Item("spicalprice").ToString, ".", 1) = 0 Then
                        .msrp = ecdt.Select().FirstOrDefault.Item("spicalprice").ToString + ".00"
                    Else
                        .msrp = Math.Round(CDbl(ecdt.Select().FirstOrDefault.Item("spicalprice").ToString), 2)
                    End If
```

![](../.gitbook/assets/gif-20191127-shang-wu-103653.gif)

```text
Imports System.IO
Imports System.Security.Cryptography
Imports Newtonsoft.Json
Imports Newtonsoft.Json.Linq
Imports System.Net
Imports System.Data

Public Class YahooShoppingSCM_API

#Region "2019-11-15 精技雅虎購物中心API專案"
    '/////////////////////////////////////////////////////////////////////////////////
    ' 主程式表單
    '
    ' 建檔人員: 育誠
    ' 版   本: version 1
    ' 建檔日期: 2019-11-15
    ' 參考   : 雅虎AP
    ' 修改記錄: 
    ' 關連程式:
    ' 呼叫來源:
    '/////////////////////////////////////////////////////////////////////////////////

#Region "YahooShoppingSCM_API_request (header_加密取得_sp cookie)"
    '依雅虎購物中心api_sign in_規格需求加密
    Public Shared Function Get_YSSCM_CookieCollection()

        'HTTP_request需求包含4個 header (api-token、api-version、api-timesta、api-signture)與 Credential密文(加密後的cookie)
        '雅虎購物中心API_KEY查詢 : https://scm.monday.com.tw/ApprovalForm/Query/ApiKeyQuery.aspx

        'request實際欄位名稱為 api-timestamp 為Request發送當下的UnixTimestamp，例如1548225833，此Timestamp的有效期限為90秒
        Dim timestamp As String = Int((DateTime.UtcNow - New DateTime(1970, 1, 1, 0, 0, 0)).TotalSeconds + 0.5) '1573455721 
        'request實際欄位名稱為 api-token 為API Key查詢頁提供之Token
        Dim token As String = "Supplier_478"
        '供應商編號
        Dim supplierId As Integer = 478
        '為API Key查詢頁提供之KeyValue
        Dim secretKey As String = "yrsW8ukCXsEZOkKmegF7T2WrK0MTq9U2jH3DmSIod24="
        '為API Key查詢頁提供之KeyIV
        Dim iv As String = "MmThDVTcmRpN5jFgzxb+nQ=="
        '為API Key查詢頁提供之SaltKey
        Dim saltKey As String = "doTzTL6Ev0ttm2OF3kxpzloGTtxky1eI"
        'request實際欄位名稱為 api-Version 為API Key查詢頁提供之Version
        Dim Version As String = "1"

        '***** checked *****

        '***** Credential Plaintext 憑證文本 *****

        Dim cookie As JObject = New Newtonsoft.Json.Linq.JObject
        cookie.Add("supplierId", supplierId)
        'Dim plaintext As String = cookie.ToString
        Dim plaintext As String = "{" + Chr(34) + "supplierId" + Chr(34) + ":478}"

        '***** checked *****

        '***** Credential Signature 憑證密文 *****
        '參考文章 : https://stackoverflow.com/questions/5987186/aes-encrypt-string-in-vb-net
        '參考文章 : https://dotblogs.com.tw/yc421206/archive/2012/04/18/71609.aspx
        '參考文章 : https://stackoverflow.com/questions/723129/using-aescryptoserviceprovider-in-vb-net
        '參考文章 : https://stackoverflow.com/questions/3962900/how-do-i-encrypt-a-string-in-vb-net-using-rijndaelmanaged-and-using-pkcs5-paddi
        'AES / CBC / PKCS5Padding 加密方式
        '此步驟使用到 supplierId / secretKey / iv

        Dim aes As AesCryptoServiceProvider = New AesCryptoServiceProvider()

        aes.Key = Convert.FromBase64String(secretKey)
        aes.IV = Convert.FromBase64String(iv)
        aes.Mode = CipherMode.CBC
        aes.Padding = PaddingMode.PKCS7

        'Dim encryptor = aes.CreateEncryptor()
        'Dim encrypted = encryptor.TransformFinalBlock(Encoding.UTF8.GetBytes(plaintext), 0, Encoding.UTF8.GetBytes(plaintext).Length)
        'aes.Clear()
        Dim ms As MemoryStream = New MemoryStream()
        Dim cs As CryptoStream = New CryptoStream(ms, aes.CreateEncryptor(), CryptoStreamMode.Write)
        cs.Write(Encoding.UTF8.GetBytes(plaintext), 0, Encoding.UTF8.GetBytes(plaintext).Length)
        cs.FlushFinalBlock()
        Dim encrypted = ms.ToArray()

        Dim ciphertext As String = ""
        ciphertext = Convert.ToBase64String(encrypted)

        '***** checked *****

        '***** Credential Signature 憑證簽章 *****
        '參考文章 : https://kknews.cc/zh-tw/code/33bzv9y.html
        'hmacsha512 加密方式
        '此步驟使用到 timestamp / token / saltKey / secretKey

        Dim signatureSource As String = String.Format("{0}{1}{2}{3}", timestamp, token, saltKey, ciphertext)

        Dim utf8 As UTF8Encoding = New UTF8Encoding()
        Dim keyByte As Byte() = utf8.GetBytes(secretKey)
        Dim HMACSHA512 As HMACSHA512 = New HMACSHA512(keyByte)
        Dim messageBytes As Byte() = utf8.GetBytes(signatureSource)
        Dim hashmessage As Byte() = HMACSHA512.ComputeHash(messageBytes)

        Dim builder As New StringBuilder(hashmessage.Length * 2)
        For Each data As Byte In hashmessage
            builder.Append(Convert.ToString(data, 16).PadLeft(2, "0"c).PadRight(2, " "c))
        Next

        Dim metadata As Byte() = Encoding.UTF8.GetBytes(builder.ToString)

        Dim signaturebyte As Byte() = Encoding.Convert(Encoding.UTF8, Encoding.GetEncoding("iso-8859-1"), metadata)
        Dim signature As String = System.Text.Encoding.Default.GetString(signaturebyte)

        '***** 將包裹塞入封包header *****
        '實作 HttpWebRequest
        Dim request As HttpWebRequest = WebRequest.Create("https://tw.supplier.yahoo.com/api/spa/v1/signIn")
        request.CookieContainer = New CookieContainer()
        request.Method = "POST"
        request.Headers.Add("api-token", token)
        request.Headers.Add("api-keyversion", Version)
        request.Headers.Add("api-timestamp", timestamp)
        request.Headers.Add("api-signature", signature)
        request.ContentType = "application/json"
        request.Headers.Add("charset", "utf-8")
        '禁止轉址
        request.AllowAutoRedirect = False

        '內容轉為資料流
        Dim st As Stream = request.GetRequestStream()
        Dim byteArray As Byte() = Encoding.Default.GetBytes(ciphertext)
        st.Write(byteArray, 0, byteArray.Length)

        '執行HttpWebRequest
        Dim response As HttpWebResponse = request.GetResponse()
        '擷取response cookie string
        '參考 http://storynsong01.pixnet.net/blog/post/116435414-%E3%80%90vba%E3%80%91%E5%B8%B8%E7%94%A8vb%E5%AD%97%E4%B8%B2%E8%99%95%E7%90%86%E5%87%BD%E6%95%B8
        Dim _sp As String = response.Cookies.Item("_sp").ToString
        _sp = Microsoft.VisualBasic.Mid(_sp, 5, _sp.Length)
        '釋放response
        response.Close()
        '回傳依header計算之CookieCollection
        Return response.Cookies

    End Function

#End Region

#Region "YahooShoppingSCM_API_request (使用_sp cookie 取 WSSID token)"
    '依雅虎購物中心api_sign in_取得之cookie用另外一個api取得X-YahooWSSID-Authorization
    Public Shared Function Get_YSSCM_WSSID_token(CookieCollection As CookieCollection)

        'Dim CookieCollection As CookieCollection = Get_YSSCM_CookieCollection()

        '***** 將_sp塞入封包cookie *****
        '實作 HttpWebRequest
        '參考 https://blog.csdn.net/u011412226/article/details/51049045
        '參考 http://hk.voidcc.com/question/p-abgfsgcw-re.html
        Dim request As HttpWebRequest = WebRequest.Create("https://tw.supplier.yahoo.com/api/spa/v1/token")

        request.CookieContainer = New CookieContainer()
        request.CookieContainer.Add(CookieCollection)

        request.Method = "GET"

        '禁止轉址
        request.AllowAutoRedirect = False

        '執行HttpWebRequest
        Dim response As HttpWebResponse = CType(request.GetResponse(), HttpWebResponse)
        '回傳資料解碼
        '參考 https://stackoverflow.com/questions/3273205/read-text-from-response
        '參考 https://liuder.pixnet.net/blog/post/96806748-%5Bvb.net%5D%E6%8E%A5%E6%94%B6json%E6%A0%BC%E5%BC%8F%E8%B3%87%E6%96%99%EF%BC%8C%E4%B8%A6%E8%BD%89%E7%82%BA%E7%89%A9%E4%BB%B6%E6%88%96%E8%B3%87%E6%96%99%E8%A1%A8
        Dim reader = New System.IO.StreamReader(response.GetResponseStream(), ASCIIEncoding.ASCII)
        Dim responseText As String = reader.ReadToEnd()
        Dim Obj As Newtonsoft.Json.Linq.JObject = Newtonsoft.Json.JsonConvert.DeserializeObject(responseText)
        Dim wssid As String = Obj.Item("wssid").ToString
        '釋放response
        response.Close()
        '回傳依cookie計算之wssid JObject
        Return wssid

    End Function

#End Region

#Region "YahooShoppingSCM_API_request (使用API)"
    ''' <summary>
    ''' 依雅虎購物中心文件規則呼叫api
    ''' (註:無做錯誤處理與反饋)
    ''' </summary>
    ''' <param name="Method">Get/Post</param>
    ''' <param name="URL"></param>
    ''' <param name="JSONString">整理過後的JSONString</param>
    ''' <remarks></remarks>
    Public Shared Function Get_YSSCM_API_Response(Method As String, URL As String, JSONString As String)

        '取得雅虎購物中心驗證cookie與wssid
        Dim CookieCollection As CookieCollection = Get_YSSCM_CookieCollection()
        Dim WSSID As String = Get_YSSCM_WSSID_token(CookieCollection)
        '***** 將cookie與wssid塞入封包 *****
        '實作 HttpWebRequest
        Dim request As HttpWebRequest = WebRequest.Create(URL) '丟入函數的URL參數
        request.CookieContainer = New CookieContainer()
        request.CookieContainer.Add(CookieCollection)
        request.Headers.Add("X-YahooWSSID-Authorization", WSSID)
        request.Method = Method '丟入函數的Method參數
        '禁止轉址
        request.AllowAutoRedirect = False
        '內容轉為資料流
        If JSONString <> "" Or JSONString <> Nothing Then
            Dim st As Stream = request.GetRequestStream()
            Dim byteArray As Byte() = Encoding.Default.GetBytes(JSONString)
            st.Write(byteArray, 0, byteArray.Length)
        End If
        '執行HttpWebRequest
        Try

            Dim response As HttpWebResponse = CType(request.GetResponse(), HttpWebResponse)
            '回傳資料解碼
            Dim reader = New System.IO.StreamReader(response.GetResponseStream(), ASCIIEncoding.UTF8)
            Dim responseText As String = reader.ReadToEnd()
            'Dim Obj As Newtonsoft.Json.Linq.JObject = Newtonsoft.Json.JsonConvert.DeserializeObject(responseText)
            '釋放response
            response.Close()
            '回傳API JObject
            Return responseText

        Catch ex As Exception
            Return ex.ToString
        End Try


    End Function

#End Region

#Region "YahooShoppingSCM_API_request (URL TEST)"
    ''' <summary>
    ''' 因精技需求分類優先串接之API
    ''' (註:無做錯誤處理與反饋)
    ''' </summary>
    ''' <remarks></remarks>
    Public Shared Sub API_URL_TEST()

        '雅虎API URL TEST查詢值在Yahoo Shopping SCM API 文件上
        Dim v1 As String = "https://tw.supplier.yahoo.com/api/spa/v1/"

        'GET Yahoo Shopping SCM API
        '查詢使用者資訊
        Dim B As String = v1 + "user" '暫不使用
        Dim C As String = v1 + "user?fields=-profile" '暫不使用
        '查詢雅虎服務窗口
        Dim D As String = v1 + "serviceDesks?type=proposal" '暫不使用
        '查詢類別
        Dim E As String = v1 + "categories?categoryId=catItem33908&fields=children,parents" 'ok
        '查詢結構化數據屬性集群
        '固定 proposalType = newListing 只幫精技做一次性新增一般賣場其餘修改接透過雅虎購物中心後台
        Dim F As String = v1 + "struDataAttrClusters?categoryId=catItem95356&proposalType=newListing" 'ok

        '查詢提案 有例外詳於文件
        Dim G As String = v1 + "proposals" '暫不使用
        '查詢登錄供應商列表
        Dim I As String = v1 + "listing/3367399?fields=" '暫不使用
        '範例json格式
        'Request GET / spa / v1 / listing
        'Response Status HTTP/1.1 201
        '單層屬性賣場
        'https://docs.google.com/document/d/1Zuw1Ps0Xh5DhiY97cP_x1QzRjgJezppIIqzkJnWvIj8/edit
        '雙層屬性賣場
        'https://docs.google.com/document/d/1yKZHkZa4QvgKYUxOWlWM30JBIXYOLwPVQcHLJ3FG7sk/edit
        '無屬性賣場
        'https://docs.google.com/document/d/1YeCaOPA51Brzw5nVLEcSYewlqtEBPxuEZ40h9zQgZmU/edit



        'POST Yahoo Shopping SCM API
        '創建提案
        Dim H As String = v1 + "proposals" 'ok
        '範例json格式 
        'Request POST / spa / v1 / proposals body
        'Response Status HTTP/1.1 201




        '新增一般賣場(二階層屬性)
        'Request
        'https://docs.google.com/document/d/1-ROog-SSxvCIKkWRfcjadtFmP_gnL4PkqbR7TfvR5Cg/edit?pli=1
        'Response
        'https://docs.google.com/document/d/1Xw3Rf_LirWAizvjJU9QV44Nye206AEwKTpyzj70iDEY/edit 

        '修改賣場/商品詳情提案
        'Request
        'https://docs.google.com/document/d/1lpaxTgZsCequXiyj7GO0XcWXyzDe6yAFfmNQiUbT7tI/edit?pli=1
        'Response
        'https://docs.google.com/document/d/1HqPLzfY9XbgnqlGpnhKe04kWoKE0KDUXd4xdNykDI2s/edit

        '修改賣場影片(有屬性)
        'Request
        'https://docs.google.com/document/d/13xU9qoNWb07MDTgyiFBmr-fTJqby0eMsK3oWmW0GPpI/edit?pli=1
        'Response
        'https://docs.google.com/document/d/1eekPRUkLJe6bROHcAF0WqsWAB0ETEwiMfZ48Oah03w0/edit

        '修改賣場影片(無屬性)
        'Request
        'https://docs.google.com/document/d/1EhX2ekywSBG16FCGE4meyPE1jDv4Z8ksIJMBMJlMz84/edit?pli=1
        'Response
        'https://docs.google.com/document/d/15rp85S6iSyUn106okz87ULoIt2AxQr51fS1P2PklLlo/edit

        '檔案上傳流程 取得臨時憑證獲取token將檔案上傳至雅虎購物中心提供之aws
        'https://aws.amazon.com/getting-started/tools-sdks/
        '上傳成功後由response header 取得ETag 透過GET /fileObhects/{ETag} 取得該檔案URL
        Dim J As String = "https://tw.buy.yahoo.com/api/fileUploader/v1/credentials" '暫不使用
        '查詢檔案上傳臨時憑證token
        Dim K As String = "https://tw.buy.yahoo.com/api/fileUploader/v1/fileObjects/{ETag}" '暫不使用
        '查詢上傳檔案url

        '''''''測試''''''
        Dim Z As String = Get_YSSCM_API_Response("GET", B, "")







        '序列化JSONTEXT
        '參考 https://stackoverflow.com/questions/8118019/vb-net-json-deserialize
        'Dim testsss As YahooShoppingSCM_proposals.Rootobject = New YahooShoppingSCM_proposals.Rootobject{applicant="abc"}
        ' Dim testobj As Newtonsoft.Json.Linq.JObject = JsonSerializer.Serialize(testsss)



    End Sub
#End Region

#Region "隱藏其他頁籤"
    '因精技需求改寫yahooapi2為串yahoo購物商城，隱藏部分未改寫功能。
    Public Shared Sub HideTabPage()

        'Me.TabPage_OnlineOffline.Parent = Nothing
        'Me.TabPage_UpdatePrice.Parent = Nothing
        'Me.TabPage_UpdateMain.Parent = Nothing
        'Me.TabPage_stock.Parent = Nothing
        'Me.TabPage_ReUploadImage.Parent = Nothing
        'Me.TabPage_RecProcStatus.Parent = Nothing
        'Me.TabPage_DBSetting.Parent = Nothing
        'Me.TabPage_TestAPI.Parent = Nothing

        'GET_categories_API()
        'API_URL_TEST()
        'GET_struDataAttrClusters_API()
        'TESTpost.Post_proposals_API_TEST()
        'Post_proposals_API()
    End Sub
#End Region

#Region "GET YahooShoppingSCM_categories API (取回類別架構)"
    ''' <summary>
    ''' 查詢類別並存入
    ''' 表名稱:"YahooshoppingSCM_API_Category" 、 位址:10.0.11.1 (LS3C_V2_2005)
    ''' (註:無做錯誤處理與反饋)
    ''' </summary>
    ''' <remarks></remarks>
    Public Sub GET_categories_API()

        '雅虎API URL TEST查詢值在Yahoo Shopping SCM API 文件上
        Dim v1 As String = "https://tw.supplier.yahoo.com/api/spa/v1/"
        '精技提案類別項目 Max 50個超過不知道會怎樣文件沒寫 ，頂層有一個大類 z1，但呼叫了回傳空值
        Dim subs As String = "sub1,sub2,sub15,sub17,sub22,sub24,sub26,sub27,sub34,sub36,sub38,sub51,sub52,sub55,sub107,sub112,sub121,sub168,sub197,sub215,sub408,sub431,sub436,sub453,sub454,sub455,sub469,sub583,sub617,sub681,sub682,sub693,sub695,sub696,sub704,sub788,sub792,sub793,sub794,sub810,sub812"
        '查詢類別
        Dim E As String = v1 + "categories?categoryId=" + subs + "&fields=children,parents" 'ok
        '呼叫API
        Dim Z As String = Get_YSSCM_API_Response("Get", E, "")
        '轉為JOBJECT
        Dim Obj As Newtonsoft.Json.Linq.JObject = Newtonsoft.Json.JsonConvert.DeserializeObject(Z)

        '需要將sub與categoryId存入sql後，因為直接呼叫sub無categoryId名稱
        '必須再取出categoryId整理為一包(有max50限制)呼叫api才取的到categoryId的中文名稱
        '將jsonobj資料存入mssql可能有兩種方式 
        '1.程式內將json整理為 datatable class 類別檔，在整包datatable存入 mssql
        '參考 https://dotblogs.com.tw/justforgood/2014/05/29/145303
        '參考 http://www.infolight.com.tw/WebClient/FAQResponse.aspx?QuestionID=NTM2
        '參考 https://blog.xuite.net/beary2k2/twblog/567089844-MS+SQL+Server+%E5%AD%98%E5%8F%96+Datatable+for+C%23
        '參考 https://stackoverflow.com/questions/21820198/accessed-jarray-values-with-invalid-key-value-fields-array-position-index-ex
        '2.跑回圈整理成insert tsql string 整包進入 sql 儲存
        'Insert Query vs SqlBulkCopy 效能比較 :
        '參考 https://stackoverflow.com/questions/33774163/insert-query-vs-sqlbulkcopy-which-one-is-best-as-performance-wise-for-insert-r

        '嘗試第一種方法 但不特別建置 類別檔
        Dim dt As DataTable = New DataTable
        Dim newRow As DataRow = Nothing
        dt.Columns.Add("subId")
        dt.Columns.Add("subname")
        dt.Columns.Add("subVisible")
        dt.Columns.Add("categoryId")
        dt.Columns.Add("categoryIdname")
        dt.Columns.Add("categoryVisible")
        dt.Columns.Add("catItemId")
        dt.Columns.Add("catItemIdname")
        dt.Columns.Add("catItemVisible")
        '一開始不清楚rows.add新增機制卡在第一層迴圈引入 0 1，全部改至第二層迴圈即可
        For number As Int32 = 0 To Obj("categories").Count - 1 Step 1
            For number2 As Int32 = 0 To Obj("categories")(number).Item("childrenIdList").Count - 1 Step 1

                '接著必須要將 categoryID 查詢出來再對 GET api/spa/v1/categories 要回 categoryIdname
                '但 categoryId 查詢參數似乎有限制 max50 筆，依寫 code 當下約8百多筆資料
                '採取呼叫一次寫入一次方案 ... 總共幾筆就呼叫幾次
                '直接利用第一次呼叫api之回傳整理過後的 datatable dt

                Dim categoryId As String = Obj("categories")(number).Item("childrenIdList")(number2).ToString() 'categoryId 
                '查詢類別
                Dim X As String = v1 + "categories?categoryId=" + categoryId + "&fields=children,parents" 'ok
                '呼叫API
                Dim XX As String = Get_YSSCM_API_Response("Get", X, "")
                '轉為JOBJECT
                Dim ObjX As Newtonsoft.Json.Linq.JObject = Newtonsoft.Json.JsonConvert.DeserializeObject(XX)

                '無值須填空
                '第三層catItem
                For number3 As Int32 = 0 To ObjX("children").Count - 1 Step 1

                    newRow = dt.NewRow
                    '看似重複應該可以抓出來寫成內函式

                    '第一次呼叫API
                    Dim subId As String = Obj("categories")(number).Item("categoryId").ToString()

                    If subId = "" Or Nothing Then
                        newRow(0) = ""
                    Else
                        newRow(0) = subId
                    End If

                    Dim subname As String = Obj("categories")(number).Item("name").ToString()

                    If subname = "" Or Nothing Then
                        newRow(1) = ""
                    Else
                        newRow(1) = subname
                    End If


                    Dim subVisible As String = Obj("categories")(number).Item("visible").ToString()

                    If subVisible = "" Or Nothing Then
                        newRow(2) = ""
                    Else
                        newRow(2) = subVisible
                    End If


                    Dim categoryIdz As String = Obj("categories")(number).Item("childrenIdList")(number2).ToString()

                    If categoryIdz = "" Or Nothing Then
                        newRow(3) = ""
                    Else
                        newRow(3) = categoryIdz
                    End If


                    '第二次呼叫API
                    Dim categoryIdname As String = ObjX("categories")(0).Item("name").ToString()

                    If categoryIdname = "" Or Nothing Then
                        newRow(4) = ""
                    Else
                        newRow(4) = categoryIdname
                    End If

                    Dim categoryVisible As String = ObjX("categories")(0).Item("visible").ToString()

                    If categoryVisible = "" Or Nothing Then
                        newRow(5) = ""
                    Else
                        newRow(5) = categoryVisible
                    End If



                    '第三層catItem
                    Dim catItemId As String = ObjX("children")(number3).Item("categoryId").ToString()

                    If catItemId = "" Or Nothing Then
                        newRow(6) = ""
                    Else
                        newRow(6) = catItemId
                    End If

                    Dim catItemIdname As String = ObjX("children")(number3).Item("name").ToString()

                    If catItemIdname = "" Or Nothing Then
                        newRow(7) = ""
                    Else
                        newRow(7) = catItemIdname
                    End If

                    Dim catItemVisible As String = ObjX("children")(number3).Item("visible").ToString()

                    If catItemVisible = "" Or Nothing Then
                        newRow(8) = ""
                    Else
                        newRow(8) = catItemVisible
                    End If

                    dt.Rows.Add(newRow)
                Next

            Next
        Next

        If dt.Rows.Count > 0 Then
            '必須先清空一次整個table避免重複寫入
            Dim sql As String = "DELETE FROM YahooshoppingSCM_API_Category"
            '利用SqlBulkCopy將datatable存入db
            If EC.DB.ExecuteDataTable(sql).Rows.Count = Nothing Then
                Using bulkcopy As System.Data.SqlClient.SqlBulkCopy = New System.Data.SqlClient.SqlBulkCopy(EC.DB.GetConnString())
                    bulkcopy.DestinationTableName = "YahooshoppingSCM_API_Category" '表名稱 位址:10.0.11.1 (LS3C_V2_2005)
                    If bulkcopy.DestinationTableName <> Nothing Or bulkcopy.DestinationTableName <> "" Then
                        bulkcopy.BatchSize = dt.Rows.Count
                        bulkcopy.BulkCopyTimeout = 120
                        bulkcopy.WriteToServer(dt)
                    End If
                    bulkcopy.Close()
                End Using
            End If
        End If

    End Sub

#End Region

#Region "GET YahooShoppingSCM_struDataAttrClusters API (取回結構化商品標籤)"
    ''' <summary>
    ''' 查詢類別並存入
    ''' 表名稱:"YahooshoppingSCM_API_Category" 、 位址:10.0.11.1 (LS3C_V2_2005)
    ''' (註:無做錯誤處理與反饋)
    ''' </summary>
    ''' <remarks></remarks>
    Public Shared Sub GET_struDataAttrClusters_API()

        '雅虎API URL TEST查詢值在Yahoo Shopping SCM API 文件上
        Dim v1 As String = "https://tw.supplier.yahoo.com/api/spa/v1/"
        '查詢資料庫內抓回之catItem作為查詢參數
        'Category ID which prefixed with its level, allow level 'catItem' only, e.g. 'catItem5566'
        'Must be a pair parameter of proposalType.
        '一次只能一筆catItemID所以可以將查詢回來的DataReader分row呼叫api
        Dim catItems As IDataReader = EC.DB.ExecuteReader("SELECT catItemID FROM [LS3C_V2_2005].[dbo].[YahooshoppingSCM_API_Category] WITH(NOLOCK)")

        '逐筆存成datable 再利用 SqlBulkCopy 存入資料庫
        '參考 : GET_categories_API() 就不再多做註解
        Dim dt As DataTable = New DataTable
        Dim newRow As DataRow = Nothing
        dt.Columns.Add("catItems")
        dt.Columns.Add("struDataAttrClusterId")
        dt.Columns.Add("struDataAttrClusterName")
        dt.Columns.Add("Attrtype")
        dt.Columns.Add("Attrname")
        dt.Columns.Add("Attrrequired")
        dt.Columns.Add("Attrvalues")
        '錯誤處理
        Dim ErrorcatItem As String

        '查出來後利用dataread逐筆呼叫api
        Do While catItems.Read()

            '查詢結構化屬性 
            Dim catItem As String = catItems.GetString(0)
            Dim E As String = v1 + "struDataAttrClusters?categoryId=" + catItem + "&proposalType=newListing" 'ok

            Try
                '呼叫API
                Dim Z As String = Get_YSSCM_API_Response("Get", E, "")

                '轉為JOBJECT
                Dim Obj As Newtonsoft.Json.Linq.JObject = Newtonsoft.Json.JsonConvert.DeserializeObject(Z)

                For number As Int32 = 0 To Obj("struDataAttrClusters").Count - 1 Step 1
                    For number2 As Int32 = 0 To Obj("struDataAttrClusters")(number).Item("attributes").Count - 1 Step 1

                        newRow = dt.NewRow

                        '20191125 捕塞 catItems

                        newRow(0) = catItems.Item("catItemID").ToString


                        '看似重複應該可以抓出來寫成內函式

                        Dim struDataAttrClusterId As String = Obj("struDataAttrClusters")(number).Item("id").ToString()
                        If struDataAttrClusterId = "" Or Nothing Then
                            newRow(1) = ""
                        Else
                            newRow(1) = struDataAttrClusterId
                        End If

                        Dim struDataAttrClusterName As String = Obj("struDataAttrClusters")(number).Item("name").ToString()
                        If struDataAttrClusterName = "" Or Nothing Then
                            newRow(2) = ""
                        Else
                            newRow(2) = struDataAttrClusterName
                        End If

                        Dim Attrtype As String = Obj("struDataAttrClusters")(number).Item("attributes")(number2).Item("constraints").Item("type").ToString()
                        If Attrtype = "" Or Nothing Then
                            newRow(3) = ""
                        Else
                            newRow(3) = Attrtype
                        End If

                        Dim Attrname As String = Obj("struDataAttrClusters")(number).Item("attributes")(number2).Item("name").ToString()
                        If Attrname = "" Or Nothing Then
                            newRow(4) = ""
                        Else
                            newRow(4) = Attrname
                        End If

                        Dim Attrrequired As String = Obj("struDataAttrClusters")(number).Item("attributes")(number2).Item("required").ToString()
                        If Attrrequired = "" Or Nothing Then
                            newRow(5) = ""
                        Else
                            newRow(5) = Attrrequired
                        End If

                        Dim Attrvalues As String = Obj("struDataAttrClusters")(number).Item("attributes")(number2).Item("values").ToString()
                        If Attrvalues = "" Or Nothing Then
                            newRow(6) = ""
                        Else
                            newRow(6) = Attrvalues
                        End If


                        dt.Rows.Add(newRow)

                    Next
                Next

            Catch ex As Exception
                '不知道為何會有些catItem會呼叫不到結構化標籤，嘗試過與Visible也無關係
                ErrorcatItem += "," + catItem

            End Try

            Dim dtc As String = dt.Rows.Count

        Loop

        If dt.Rows.Count > 0 Then
            '必須先清空一次整個table避免重複寫入
            Dim sql As String = "DELETE FROM YahooshoppingSCM_API_struDataAttrClusters"
            '利用SqlBulkCopy將datatable存入db
            If EC.DB.ExecuteDataTable(sql).Rows.Count = Nothing Then
                Using bulkcopy As System.Data.SqlClient.SqlBulkCopy = New System.Data.SqlClient.SqlBulkCopy(EC.DB.GetConnString())
                    bulkcopy.DestinationTableName = "YahooshoppingSCM_API_struDataAttrClusters" '表名稱 位址:10.0.11.1 (LS3C_V2_2005)
                    If bulkcopy.DestinationTableName <> Nothing Or bulkcopy.DestinationTableName <> "" Then
                        bulkcopy.BatchSize = dt.Rows.Count
                        bulkcopy.BulkCopyTimeout = 120
                        bulkcopy.WriteToServer(dt)
                    End If
                    bulkcopy.Close()
                End Using
            End If
        End If


    End Sub

#End Region

#Region "Post YahooShoppingSCM_proposals API (上傳上架商品)"
    '依雅虎購物中心api_sign in_規格需求加密
    Public Shared Function Post_proposals_API()

        '兩種方式:使用第二種方式
        '1查完整拉出一張大表 ( 較複雜且須在後端操控資料在查詢
        '2分別依需求查 ( 較直覺但容易出錯但也容易偵錯

        '資料庫欄位設計將level設為死資料如要更改再進程式更改，較方便資料庫欄位設計
        '資料庫內的level只來判定spec階層

        'list筆數
        Dim listreader = EC.DB.ExecuteReader("SELECT ProductNo FROM YahooshoppingSCM_API_list with(NOLOCK) WHERE posteddate IS NULL")

        Do While listreader.Read()

            '查表 YahooshoppingSCM_API_list
            Dim ProductNo = listreader.GetString(0)
            Dim sql = "SELECT * FROM YahooshoppingSCM_API_list with(NOLOCK) WHERE ProductNo='" + ProductNo + "'"
            Dim dt = EC.DB.ExecuteDataTable(sql)
            '查表 list
            Dim sqlec = "SELECT * FROM list with(NOLOCK) WHERE ProductNo='" + ProductNo + "'"
            Dim ecdt = EC.DB.ExecuteDataTable(sqlec)
            '查表 YahooshoppingSCM_API_list_attributes
            Dim sqlattr = "SELECT * FROM YahooshoppingSCM_API_list_attributes with(NOLOCK) WHERE ProductNo='" + ProductNo + "'"
            Dim attrdt = EC.DB.ExecuteDataTable(sqlattr)


            '對於值有疑問可以看左邊類別檔註解
            Dim obj = New YahooShoppingSCM.JSONobj
            obj.applicant = dt.Select().FirstOrDefault.Item("applicant").ToString
            obj.reviewStatus = "draft" '定為常數: 測試draft，正式上架審核composing
            obj.subStationId = dt.Select().FirstOrDefault.Item("subStationId").ToString
            obj.type = "newListing" '定為常數: newListing 新增一般賣場

            obj.listing = New YahooShoppingSCM.Listing
            With obj.listing
                .catItemId = dt.Select().FirstOrDefault.Item("catItemId").ToString
                .deliveryType = "normal" '定為常數: normal 正常交貨期

                If StrComp(ecdt.Select().FirstOrDefault.Item("SpicalPrice").ToString, ".") = -1 Then
                    .price = ecdt.Select().FirstOrDefault.Item("SpicalPrice").ToString + ".00"
                Else
                    .price = ecdt.Select().FirstOrDefault.Item("SpicalPrice").ToString
                End If
                .seoUrl = ecdt.Select().FirstOrDefault.Item("ProductName").ToString
            End With

            obj.product = New YahooShoppingSCM.Product
            With obj.product
                .attributeDisplayMode = "table" '定為常數
                .catItemId = dt.Select().FirstOrDefault.Item("catItemId").ToString
                .contentRating = dt.Select().FirstOrDefault.Item("contentRating").ToString


                If StrComp(ecdt.Select().FirstOrDefault.Item("Cost").ToString, ".") = -1 Then
                    .cost = ecdt.Select().FirstOrDefault.Item("Cost").ToString + ".00"
                Else
                    .cost = ecdt.Select().FirstOrDefault.Item("Cost").ToString
                End If

                If StrComp(ecdt.Select().FirstOrDefault.Item("spicalprice").ToString, ".") = -1 Then
                    .msrp = ecdt.Select().FirstOrDefault.Item("spicalprice").ToString + ".00"
                Else
                    .msrp = ecdt.Select().FirstOrDefault.Item("spicalprice").ToString
                End If


                .name = ecdt.Select().FirstOrDefault.Item("ProductName").ToString
                .struDataAttrClusterId = attrdt.Select().FirstOrDefault.Item("struDataAttrClusterId").ToString
                .copy = dt.Select().FirstOrDefault.Item("copy").ToString
            End With

            obj.product.attributes() = New List(Of YahooShoppingSCM.Attribute)
            'attributes迴圈次數與資料查詢
            Dim attributesreader = EC.DB.ExecuteReader("SELECT * FROM YahooshoppingSCM_API_list_attributes with(NOLOCK) WHERE ProductNo ='" + ProductNo + "' AND type ='attr'")
            Do While attributesreader.Read()
                With obj.product.attributes()

                    Dim items As YahooShoppingSCM.Attribute = New YahooShoppingSCM.Attribute
                    items.name = attributesreader.Item(2).ToString
                    items.values = New List(Of String)
                    'values陣列迴圈
                    Dim values() = Split(attributesreader.GetString(3), ",")
                    For number As Integer = 0 To values.Count - 1 Step 1

                        Dim feedback = values(number).ToString()
                        items.values.Add(feedback)

                    Next

                    obj.product.attributes().Add(items)

                End With
            Loop

            With obj.product
                '很詭異的寫法做完一包後在塞進類別內，原來那一包類別檔呼叫不到子類
                '不知為何類別不能直接繼承某個物件集合(物件集合內有n個物件)
                '就算類別屬性 Shared 也呼叫不到 ...
                '最後是因為發現物件內的物件並非物件集合所以只有一筆資料所以跳過
                '參考 : https://docs.microsoft.com/zh-tw/office/vba/language/reference/user-interface-help/dictionary-object
                .shipType = New YahooShoppingSCM.Shiptype
                .shipType.id = "1"
            End With

            obj.product.models() = New List(Of YahooShoppingSCM.Model)
            '★★★★★ 第一層 ★★★★★ models內有幾個model
            '利用 YahooshoppingSCM_API_list_attributes 欄位 model 底線後數字判別有幾組
            '欄位值命名方式為ProductNo+_+modelitemNo從1開始，用於區分modelitem，如果type為attr則此值為null
            Dim mcdtcount = EC.DB.ExecuteDataTable("SELECT top 1 model FROM YahooshoppingSCM_API_list_attributes with(NOLOCK) WHERE ProductNo ='" + ProductNo + "' AND type ='modelitem' group by model ORDER BY model desc")

            For modelnum As Integer = 1 To Int(mcdtcount.Select().FirstOrDefault.Item("model").ToString) Step 1

                '這邊不延續上面串字串方式因為會出現異常的空白
                Dim mcdtsql = String.Format("SELECT *  FROM YahooshoppingSCM_API_list_attributes with(NOLOCK) WHERE ProductNo ='{0}' AND type ='modelitem' AND model = '{1}'", ProductNo, modelnum)
                '查表 YahooshoppingSCM_API_list_attributes
                Dim mcdt = EC.DB.ExecuteDataTable(mcdtsql)

                With obj.product.models()

                    Dim model As YahooShoppingSCM.Model = New YahooShoppingSCM.Model
                    model.displayName = mcdt.Select("level ='1'").FirstOrDefault.Item("displayName").ToString

                    '★★★★★★★★★★ items start ★★★★★★★★★★

                    '★★★★★ 第二層 ★★★★★
                    '這裡的迴圈跟著modelnum
                    model.items = New List(Of YahooShoppingSCM.Item)

                    '★★★★★ 第三層 ★★★★★ items內有幾個item
                    '查表 YahooshoppingSCM_API_list_attributes 
                    Dim itemcountsql = String.Format("SELECT top 1 item FROM YahooshoppingSCM_API_list_attributes with(NOLOCK) WHERE ProductNo ='{0}' AND type ='modelitem' AND [level]='2' AND model ='{1}' group by item ORDER BY item desc", ProductNo, modelnum)
                    Dim itemcount = EC.DB.ExecuteDataTable(itemcountsql)
                    For itemnum As Integer = 1 To Int(itemcount.Select().FirstOrDefault.Item("item").ToString) Step 1
                        Dim item As YahooShoppingSCM.Item = New YahooShoppingSCM.Item
                        Dim spec2sql = String.Format("ProductNo ='{0}' AND type ='modelitem' AND [level]='2' AND model ='{1}' AND item ='{2}'", ProductNo, modelnum, itemnum)

                        item.displayName = mcdt.Select(spec2sql).FirstOrDefault.Item("displayName").ToString

                        item.spec = New YahooShoppingSCM.Spec1
                        item.spec.name = mcdt.Select(spec2sql).FirstOrDefault.Item("Attrname").ToString

                        'spec裡的values有幾個value  陣列方式存到 value 內
                        item.spec.values = New List(Of String)
                        'values陣列迴圈
                        Dim values() = Split(mcdt.Select(spec2sql).FirstOrDefault.Item("Attrvalues").ToString, ",")

                        For Number As Integer = 0 To values.Count - 1 Step 1

                            Dim feedback = values(Number).ToString()
                            item.spec.values.Add(mcdt.Select(spec2sql).FirstOrDefault.Item("Attrvalues").ToString)

                        Next

                        model.items.Add(item)
                    Next

                    '★★★★★★★★★★ items end ★★★★★★★★★★

                    '★★★★★★★★★★ videos start ★★★★★★★★★★
                    '只傳一份所以不寫迴圈
                    Dim Video As YahooShoppingSCM.Video = New YahooShoppingSCM.Video
                    Video.order = "1" '定為常數: 排序寫死只傳一部影片或不傳
                    Video.url = dt.Select().FirstOrDefault.Item("Videos").ToString
                    model.videos = New List(Of YahooShoppingSCM.Video)
                    model.videos.Add(Video)
                    '★★★★★★★★★★ videos end ★★★★★★★★★★

                    '★★★★★★★★★★ videos start ★★★★★★★★★★
                    '只傳一份所以不寫迴圈
                    Dim Image As YahooShoppingSCM.Image = New YahooShoppingSCM.Image
                    Image.order = "1" '定為常數: 排序寫死只傳一部影片或不傳
                    Image.url = dt.Select().FirstOrDefault.Item("Images").ToString
                    model.images = New List(Of YahooShoppingSCM.Image)
                    model.images.Add(Image)
                    '★★★★★★★★★★ videos end ★★★★★★★★★★

                    '★★★★★★★★★★ spec start ★★★★★★★★★★
                    Dim Spec As YahooShoppingSCM.Spec = New YahooShoppingSCM.Spec
                    Dim spec1sql = String.Format("ProductNo ='{0}' AND type ='modelitem' AND [level]='1' AND model ='{1}' ", ProductNo, modelnum)

                    Spec.name = mcdt.Select(spec1sql).FirstOrDefault.Item("Attrname").ToString()
                    Spec.values = New List(Of String)

                    Dim spec1values() = Split(mcdt.Select(spec1sql).FirstOrDefault.Item("Attrvalues").ToString, ",")

                    For Number As Integer = 0 To spec1values.Count - 1 Step 1

                        Dim feedback = spec1values(Number).ToString()
                        Spec.values.Add(feedback)

                    Next

                    model.spec = New YahooShoppingSCM.Spec
                    model.spec = Spec
                    '★★★★★★★★★★ spec end ★★★★★★★★★★

                    .Add(model)
                End With

            Next




            'shortDescription 簡短說明
            Dim sd1 = dt.Select().FirstOrDefault.Item("shortDescription_1").ToString()
            Dim sd2 = dt.Select().FirstOrDefault.Item("shortDescription_2").ToString()
            Dim sd3 = dt.Select().FirstOrDefault.Item("shortDescription_3").ToString()
            Dim sd4 = dt.Select().FirstOrDefault.Item("shortDescription_4").ToString()
            Dim sd5 = dt.Select().FirstOrDefault.Item("shortDescription_5").ToString()

            obj.product.shortDescription = New List(Of String)
            '幾筆值就add幾次這要寫迴圈
            If sd1 <> Nothing Or sd1 <> "" Then
                obj.product.shortDescription.Add(sd1)
                If sd2 <> Nothing Or sd2 <> "" Then
                    obj.product.shortDescription.Add(sd2)
                    If sd3 <> Nothing Or sd3 <> "" Then
                        obj.product.shortDescription.Add(sd3)
                        If sd4 <> Nothing Or sd4 <> "" Then
                            obj.product.shortDescription.Add(sd4)
                            If sd5 <> Nothing Or sd5 <> "" Then
                                obj.product.shortDescription.Add(sd5)
                            End If
                        End If
                    End If
                End If
            End If

            obj.product.specs = New List(Of YahooShoppingSCM.Spec2)
            '暫定為這兩個屬性為固定level 1與2
            Dim Spec2 As YahooShoppingSCM.Spec2 = New YahooShoppingSCM.Spec2
            Spec2.name = "品牌"
            Spec2.level = "1"
            obj.product.specs.Add(Spec2)

            Dim Spec3 As YahooShoppingSCM.Spec2 = New YahooShoppingSCM.Spec2
            Spec3.name = "顏色"
            Spec3.level = "2"
            obj.product.specs.Add(Spec3)

            '將資料上傳時的時間從新塞入資料表

            'Dim sqlposteddate = "UPDATE YahooshoppingSCM_API_list Set posteddate ='" + Now + "' WHERE ProductNo='" + ProductNo + "'"
            'EC.DB.ExecuteScalar(Format(sql, ProductNo))

            '完成上述結構化迴圈後將obj序列化為api所需json
            Dim JSONobj As String = Newtonsoft.Json.JsonConvert.SerializeObject(obj)

            '★★★★★★★★★★★★★★★★★★★★ "呼叫API並上傳資料" ★★★★★★★★★★★★★★★★★★★★

            '雅虎API URL TEST查詢值在Yahoo Shopping SCM API 文件上
            Dim v1 As String = "https://tw.supplier.yahoo.com/api/spa/v1/"

            'POST Yahoo Shopping SCM API
            '創建提案
            Dim H As String = v1 + "proposals" 'ok
            '範例json格式 
            'Request POST / spa / v1 / proposals body
            'Response Status HTTP/1.1 201

            '新增一般賣場(二階層屬性)
            'Request
            'https://docs.google.com/document/d/1-ROog-SSxvCIKkWRfcjadtFmP_gnL4PkqbR7TfvR5Cg/edit?pli=1
            'Response
            'https://docs.google.com/document/d/1Xw3Rf_LirWAizvjJU9QV44Nye206AEwKTpyzj70iDEY/edit 

            Dim Z As String = Get_YSSCM_API_Response("POST", H, JSONobj)

        Loop

    End Function
#End Region

#End Region
End Class

#Region "YahooShoppingSCM_proposals_TEST 測試結果"
'測試提報JSON目前已知如下 :
'(product)(attributeDisplayMode)必要 屬性名稱與值
'(product)(specs) 指定leve 與 屬性名稱
'(product)(models)(spec)leve 1 屬性名稱與值
'(product)(models)(items)(spec)leve 2 屬性名稱與值
'struDataAttrclusters有必填屬性且除了可自訂欄位值外必須選擇雅虎所提供的屬性值
'struDataAttrclusters只能用catItemId查詢
'spec1 2 必須符合 level 1 2 所指定屬性與屬性值
'影片與圖片包含html裡鑲嵌的必須通過驗證否則皆會報錯
'以下TESTJSONPROPOSALS已刪除不必要條件(皆由手動人工後台調整)
'★★★★★顏色與品牌是幾乎都會有的屬性可以設level以這兩個為定值★★★★★
Public Class TESTpost

    Public Shared Function Post_proposals_API_TEST()
        '★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        '物件轉JSON
        '參考 : https://stackoverflow.com/questions/33213265/serializing-nested-json-with-json-net-vb-net
        '物件或陣列裡面如果有物件需給定參考值

        '測試塞值後要上傳的JSON檔格式

        '問題 : 
        '類別檔雖然宣告為 List 或 物件型態 但還是必須要，
        '利用現有基類把值做出來再塞回去不太確定為何，
        '照理來說必須要從頭到尾類別ok直接塞值才對。

        '範例 :
        '另一種方式但無法在裡面再塞一個list
        'Dim items As New Dictionary(Of String, Object)
        'With items
        '    .Add("name", "")
        '    .Add("values", "")
        'End With
        '★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

        '幾筆值就add幾次這要寫迴圈
        Dim obj = New YahooShoppingSCM.JSONobj
        obj.applicant = "孫協志"
        obj.reviewStatus = "draft"
        obj.subStationId = "sub1"
        obj.type = "newListing"

        obj.listing = New YahooShoppingSCM.Listing
        With obj.listing
            .catItemId = "catItem10070"
            .deliveryType = "normal"
            .price = "100.00"
            .seoUrl = "我是商品名稱"
        End With

        obj.product = New YahooShoppingSCM.Product
        With obj.product
            .attributeDisplayMode = "table"
            .catItemId = "catItem10070"
            .contentRating = "G"
            .cost = "50.00"
            .msrp = "100.00"
            .name = "(即期品)我是商品名稱"
            .struDataAttrClusterId = "000002836363"
            .copy = "<p>內容圖片與影片需經過驗證為有效url才可提交</p>"
        End With

        '幾筆值就add幾次這要寫迴圈
        obj.product.attributes() = New List(Of YahooShoppingSCM.Attribute)
        With obj.product.attributes()

            Dim items As YahooShoppingSCM.Attribute = New YahooShoppingSCM.Attribute
            items.name = "記憶體插槽"
            items.values = New List(Of String)
            '幾筆值就add幾次這要寫迴圈
            items.values.Add(4)
            obj.product.attributes().Add(items)

        End With

        With obj.product.attributes()

            Dim items As YahooShoppingSCM.Attribute = New YahooShoppingSCM.Attribute
            items.name = "CPU類型"
            items.values = New List(Of String)
            '幾筆值就add幾次這要寫迴圈
            items.values.Add("i5")
            items.values.Add(2)
            obj.product.attributes().Add(items)

        End With

        With obj.product
            '很詭異的寫法做完一包後在塞進類別內，原來那一包類別檔呼叫不到子類
            '不知為何類別不能直接繼承某個物件集合(物件集合內有n個物件)
            '就算類別屬性 Shared 也呼叫不到 ...
            '最後是因為發現物件內的物件並非物件集合所以只有一筆資料所以跳過
            '參考 : https://docs.microsoft.com/zh-tw/office/vba/language/reference/user-interface-help/dictionary-object
            .shipType = New YahooShoppingSCM.Shiptype
            .shipType.id = "1"
        End With

        '★★★★★ 第一層 ★★★★★

        obj.product.models() = New List(Of YahooShoppingSCM.Model)
        '幾筆值就add幾次這要寫迴圈
        With obj.product.models()

            Dim model As YahooShoppingSCM.Model = New YahooShoppingSCM.Model
            model.displayName = "極致簡約Dell2019"

            '★★★★★★★★★★ items start ★★★★★★★★★★

            '★★★★★ 第二層 ★★★★★
            '幾筆值就add幾次這要寫迴圈
            model.items = New List(Of YahooShoppingSCM.Item)
            Dim item As YahooShoppingSCM.Item = New YahooShoppingSCM.Item
            item.displayName = "可以自定義"

            '★★★★★ 第三層 ★★★★★
            '幾筆值就add幾次這要寫迴圈
            item.spec = New YahooShoppingSCM.Spec1
            item.spec.name = "顏色"
            item.spec.values = New List(Of String)
            '幾筆值就add幾次這要寫迴圈
            item.spec.values.Add("灰色")
            model.items.Add(item)

            '★★★★★ 第二層 ★★★★★
            '幾筆值就add幾次這要寫迴圈
            Dim item2 As YahooShoppingSCM.Item = New YahooShoppingSCM.Item
            item2.displayName = "可以自定義2"

            '★★★★★ 第三層 ★★★★★
            '幾筆值就add幾次這要寫迴圈
            item2.spec = New YahooShoppingSCM.Spec1
            item2.spec.name = "顏色2"
            item2.spec.values = New List(Of String)
            '幾筆值就add幾次這要寫迴圈
            item2.spec.values.Add("灰色2")
            model.items.Add(item2)

            '★★★★★★★★★★ items end ★★★★★★★★★★

            '★★★★★★★★★★ videos start ★★★★★★★★★★
            '只傳一份所以不寫迴圈
            Dim Video As YahooShoppingSCM.Video = New YahooShoppingSCM.Video
            Video.order = "1"
            Video.url = ""
            model.videos = New List(Of YahooShoppingSCM.Video)
            model.videos.Add(Video)
            '★★★★★★★★★★ videos end ★★★★★★★★★★

            '★★★★★★★★★★ videos start ★★★★★★★★★★
            '只傳一份所以不寫迴圈
            Dim Image As YahooShoppingSCM.Image = New YahooShoppingSCM.Image
            Image.order = "1"
            Image.url = ""
            model.images = New List(Of YahooShoppingSCM.Image)
            model.images.Add(Image)
            '★★★★★★★★★★ videos end ★★★★★★★★★★

            '★★★★★★★★★★ spec start ★★★★★★★★★★
            Dim Spec As YahooShoppingSCM.Spec = New YahooShoppingSCM.Spec
            Spec.name = "品牌"
            Spec.values = New List(Of String)
            '幾筆值就add幾次這要寫迴圈
            Spec.values.Add("Dell戴爾")
            Spec.values.Add("Msi微星")
            model.spec = New YahooShoppingSCM.Spec
            model.spec = Spec
            '★★★★★★★★★★ spec end ★★★★★★★★★★

            .Add(model)
        End With

        obj.product.shortDescription = New List(Of String)
        '幾筆值就add幾次這要寫迴圈
        obj.product.shortDescription.Add("我是簡短說明")
        obj.product.shortDescription.Add("我是簡短說明2")


        obj.product.specs = New List(Of YahooShoppingSCM.Spec2)
        '幾筆值就add幾次這要寫迴圈
        Dim Spec2 As YahooShoppingSCM.Spec2 = New YahooShoppingSCM.Spec2
        Spec2.name = "品牌"
        Spec2.level = "1"
        obj.product.specs.Add(Spec2)

        Dim Spec3 As YahooShoppingSCM.Spec2 = New YahooShoppingSCM.Spec2
        Spec3.name = "顏色"
        Spec3.level = "2"
        obj.product.specs.Add(Spec3)


        '完成上述結構化迴圈後將obj序列化為api所需json
        Dim test_JSONobj As String = Newtonsoft.Json.JsonConvert.SerializeObject(obj)

        '測試test與ex差異

        Dim ex_JSONobj As String =
        <A>{
  "applicant": "孫協志",
  "product": {
    "attributeDisplayMode": "table",
    "attributes": [
    	{"name": "記憶體插槽",
        "values": [
          "4"
        ]},
        {"name": "光碟機",
        "values": [
          "DVD燒錄機"
        ]},
        {"name": "記憶體類型",
        "values": [
          "DDR3"
        ]},
        {"name": "網路攝影機",
        "values": [
          "自訂"
        ]},
        {"name": "無線網路",
        "values": [
          "自訂"
        ]},
        {"name": "藍牙",
        "values": [
          "3.0"
        ]},
        {"name": "I/O連接埠",
        "values": [
          "自訂"
        ]},
        {"name": "顯示卡記憶體容量(GB)",
        "values": [
          "1G"
        ]},
        {"name": "定位",
        "values": [
          "文書機"
        ]},
        {"name": "型號",
        "values": [
          "自訂"
        ]},
        {"name": "記憶體最高支援容量",
        "values": [
          "4G"
        ]},
         {"name": "電池容量(cell/mAh.)",
        "values": [
          "自訂"
        ]},
        {"name": "保固",
        "values": [
          "6個月"
        ]},
        {"name": "指紋辨識",
        "values": [
          "有指紋辨識"
        ]},
        {"name": "螢幕解析度",
        "values": [
          "HD+"
        ]},
         {"name": "螢幕尺寸(吋)",
        "values": [
          "10.1吋"
        ]},
         {"name": "記憶體容量",
        "values": [
          "4G"
        ]},
        {"name": "螢幕類型",
        "values": [
          "鏡面"
        ]},
        {"name": "固態硬碟 SSD/eMMC",
        "values": [
          "8GB"
        ]},
        {"name": "螢幕觸控",
        "values": [
          "有螢幕觸控"
        ]},
          {"name": "中央處理器型號",
        "values": [
          "AMD"
        ]},
        {"name": "重量(kg)",
        "values": [
          "自定義"
        ]},
        {"name": "螢幕解析度類型",
        "values": [
          "HD+"
        ]},
         {"name": "標準配件",
        "values": [
          "滑鼠"
        ]},
        {"name": "顯示晶片卡型號",
        "values": [
          "P4200"
        ]},
        {"name": "2.5吋傳統硬碟轉數",
        "values": [
          "無" 
        ]},
        {"name": "作業系統",
        "values": [
          "Win7 home"
        ]},
        {"name": "其他連接埠",
        "values": [
          "自定義"
        ]},
        {"name": "中央處理器品牌",
        "values": [
          "Intel"
        ]},
        {"name": "CPU類型",
        "values": [
          "i5"
        ]},
        {"name": "硬碟類型",
        "values": [
          "固態硬碟"
        ]},
        {"name": "顯示卡記憶體類型",
        "values": [
          "DDR5"
        ]},
        {"name": "顯示卡類型",
        "values": [
          "內顯"
        ]},
        {"name": "2.5吋傳統硬碟容量",
        "values": [
          "無"
        ]},
        {"name": "讀卡機",
        "values": [
          "自定義"
        ]}
    ],
    "catItemId": "catItem10070",
    "contentRating": "G",
    "cost": "1450",
    "models": [
      {
        "items": [
          {
            "spec": {
              "name": "顏色",
              "values": [
                "金色系"
              ]
            },
            "displayName": "可以自定義"
          },
          {
            "spec": {
              "name": "顏色",
              "values": [
                "灰色系"
              ]
            },
            "displayName": "灰色"
          }
        ],
        "videos": [],
        "images": [],
        "spec": {
          "name": "品牌",
          "values": [
            "Dell戴爾"
          ]
        },
        "displayName": "極致簡約Dell2019"
      },
      {
        "spec": {
          "name": "品牌",
          "values": [
            "AVITA 美國品牌"
          ]
        },
        "items": [
          {
            "spec": {
              "name": "顏色",
              "values": [
                "金色系"
              ]
            },
            "displayName": "自定義"
          },
          {
            "spec": {
              "name": "顏色",
              "values": [
                "灰色系"
              ]
            },
            "displayName": "灰色"
          }
        ],
        "videos": [],
        "images": [],
        "displayName": "低調奢華hp讚"
      }
    ],
    "msrp": "100.00",
    "name": "(即期品)我是商品名稱",

    "shipType": {
      "id": 1
    },
    "shortDescription": [
      "我是簡短說明",
      "我是簡短說明2"
    ],
    "struDataAttrClusterId": "000002836363",
    "copy": "<p>內容圖片與影片需經過驗證為有效url才可提交</p>",

    "specs": [
      {
        "level": 1,
        "name": "品牌"
      },
      {
        "level": 2,
        "name": "顏色"
      }
    ]
  },
  "reviewStatus": "draft",
  "subStationId": "sub1",
  "type": "newListing",
  "listing": {
    "catItemId": "catItem10070",
    "deliveryType": "normal",
    "price": "100.00",
    "seoUrl": "我是商品名稱"
  }
}
</A>

        Dim Match As Boolean = ex_JSONobj Like test_JSONobj

    End Function



End Class
#End Region

#Region "YahooShoppingSCM_proposals 提報架構類別"

''' <summary>
''' YahooShoppingSCM_proposals 提報架構
''' (註:部分欄位指定值須比照線上文件)
''' 現階段非必填欄位註解已利後續修改時打開
''' https://docs.google.com/document/d/1-ROog-SSxvCIKkWRfcjadtFmP_gnL4PkqbR7TfvR5Cg/edit?pli=1
''' </summary>
''' <remarks></remarks>
Public Class YahooShoppingSCM
#Region "object"
    ''' <summary>
    ''' YahooShoppingSCM_proposals 提報架構類別
    ''' 參考 : https://stackoverflow.com/questions/8118019/vb-net-json-deserialize
    ''' </summary>

    Public Class JSONobj

        ''' <summary>
        ''' 提案人，限 10 個中文字 (必填●
        ''' 
        ''' ex : 孫協志
        ''' </summary>
        Public Property applicant As String

        ''' <summary>
        ''' 商品資訊 (審核狀態 reviewStatus 非 composing 時 (必填●
        ''' </summary>
        Public Property product As Product

        ''' <summary>
        ''' 審核狀態
        ''' composing: 尚未提案 (預設)
        '''	draft: 儲存暫不提案
        '''	pendingReview: 待審核
        '''	approved: 審核已通過
        '''	declined: 審核不通過
        '''	expired: 已過審核期限
        '''	
        ''' ex : draft
        ''' </summary>
        Public Property reviewStatus As String

        ''' <summary>
        ''' 提案當下的提案站別 ID, e.g. sub1只允許供應商有簽約的子站 (必填●
        ''' 
        ''' ex : sub1
        ''' </summary>
        Public Property subStationId As String

        ''' <summary>
        ''' 提案單類型 (必填●
        ''' newProduct: 新增贈品/配件/屬性
        '''	newListing: 新增一般賣場
        '''	newListingByApi: 透過 SCM API 新增一般賣場 (不可用於新增)
        '''	updateCopy: 修改賣場/商品詳情
        '''	updateVideo: 修改賣場影片
        '''	
        ''' ex : newListing
        ''' </summary>
        Public Property type As String
        '''' <summary>
        '''' 備註，限 200 個字
        '''' 
        '''' ex : 我是備註
        '''' </summary>
        'Public Property note As String
        ''' <summary>
        ''' 賣場資訊 type 為 newListing 且 reviewStatus 非 composing 時必填 (必填●
        ''' </summary>
        Public Property listing As Listing

    End Class
#End Region



#Region "object(Product)"
    ''' <summary>
    ''' 商品資訊 (審核狀態 reviewStatus 非 composing 時必填●
    ''' </summary>
    Public Class Product
        ''' <summary>
        ''' 商品規格顯示方式 (必填●
        ''' table
        ''' list
        ''' 
        ''' ex : table
        ''' </summary>
        Public Property attributeDisplayMode As String

        ''' <summary>
        ''' 商品規格表 (必填●
        '''被 ProposalModel 中被選中的 Attribute，不可再填入此欄位
        '''若規格為 structured data 中的選項
        '''	values 需符合 structured data constraint 限制 (radiobox/checkbox)
        '''	只能有一個 `自訂其他屬性`
        '''若規格為 `自訂`
        '''	values 只能有一個值
        '''	不允許重複 `自訂規格` 名稱
        '''	`自訂規格` 名稱不允許與 structured data 中的選項重複
        '''	`自訂規格` 名稱不允許與 `自訂屬性` 名稱重複
        ''' </summary>
        <JsonProperty(PropertyName:="attributes")>
        Public Property attributes() As List(Of Attribute) = New List(Of Attribute)

        ''' <summary>
        ''' 商品目前的分類子類 往上追溯的子站要跟供應商有簽約的子站有交集 (必填●
        ''' 
        ''' ex : catItem10070
        ''' </summary>
        Public Property catItemId As String

        ''' <summary>
        ''' 內容級別 (必填●
        ''' None: 無級別 
        ''' G: 普級
        ''' PG: 保護級
        ''' PG12: 輔導級 12歲+
        ''' PG15: 輔導級 15歲+
        ''' R: 限制級
        ''' NC18: 情趣商品 (若為未滿18歲青少年不能購買商品，請選擇限制級)
        ''' 
        ''' 若 subStationId = 28(電玩 / 遊戲)， 只允許 G, PG, PG12, PG15 And R
        ''' 若 subStationId = 566， 只允許 R And NC18
        ''' 其他子站不可選 PG15
        ''' 
        ''' ex : G
        ''' </summary>
        Public Property contentRating As String

        ''' <summary>
        ''' 成本(含稅+運費)，到小數點兩位 (必填●
        ''' range: [0-9999999]
        ''' 成本(含稅+運費) = 購物中心售價 = 廠商建議價
        ''' 
        ''' ex : 50.00
        ''' </summary>
        Public Property cost As String

        '''' <summary>
        '''' 是否為即期品 (必填●
        '''' 配送方式為`快速到貨`且有填寫商品保存期限時方可為 true
        '''' 預設為 false
        '''' 
        '''' ex : true
        '''' </summary>
        'Public Property isExpiringItem As Boolean

        '''' <summary>
        '''' 是否需要安裝
        '''' 配送方式為`快速到貨`且附約資訊包含 appliance 時方可填寫
        '''' 預設為 false
        '''' 
        '''' ex : true
        '''' </summary>
        'Public Property isInstallRequired As Boolean

        '''' <summary>
        '''' 是否為大材積商品 (即將棄用)
        '''' (舊) 配送方式為`快速到貨`且附約資訊包含 appliance 時方可為 true
        '''' (新) POST/PUT 皆應為 null
        '''' 預設為 false
        '''' 
        '''' ex : true
        '''' </summary>
        'Public Property isLargeVolume As Boolean

        '''' <summary>
        '''' 是否為大型商品附屬贈品
        '''' 配送方式為`快速到貨`且附約資訊包含 appliance 時方可填寫
        '''' 預設為 false
        '''' 
        '''' ex : true
        '''' </summary>
        'Public Property isLargeVolumnProductGift As Boolean

        '''' <summary>
        '''' 是否屬於廢四機
        '''' 供應商啟用功能包含 recycleAppliance 時可選
        '''' 
        '''' ex : true
        '''' </summary>
        'Public Property isNeedRecycle As Boolean

        '''' <summary>
        '''' 是否為買斷商品
        '''' 配送方式為`快速到貨`且附約資訊包含 outrightPurchase 時方可填寫
        '''' 預設為 false
        '''' 
        '''' ex : true
        '''' </summary>
        'Public Property isOutrightPurchase As Boolean

        '''' <summary>
        '''' 最小包裝數
        '''' range: [1-32767]
        '''' 配送方式為`快速到貨`時才能更改，其餘只能為 1
        '''' 預設為 1
        '''' 
        '''' ex : 10
        '''' </summary>
        'Public Property minPackingCount As Integer

        ''' <summary>
        ''' 屬性商品型號 (不一定要給
        ''' proposal type = 14 (updateVideo) 且非無屬性賣場時須提供 (必填●
        ''' </summary>
        Public Property models() As New List(Of Model)

        ''' <summary>
        ''' 廠商建議價，到小數點兩位 (必填●
        ''' range: [0-9999999]
        ''' 成本(含稅+運費) = 購物中心售價= 廠商建議價
        ''' 
        ''' ex : 100.00
        ''' </summary>
        Public Property msrp As String

        ''' <summary>
        ''' 商品名稱，最長 45 個字 (必填●
        ''' 若為配送方式為`快速到貨`且為即期品，必須加上前綴"(即期品)"
        ''' 
        ''' (即期品)我是商品名稱
        ''' </summary>
        Public Property name As String

        '''' <summary>
        '''' 主件商品供應商商品料號，最長 40 個字
        '''' 
        '''' 12345
        '''' </summary>
        'Public Property partNo As String

        ''' <summary>
        ''' 配送方式 (必填●
        ''' 1	Home	    預設可選
        ''' 61	Express24HR	附約資訊包含 warehouse 時可選        ''' 200	ESD	        分類進階功能包含 ESD 時可選        ''' 400	EDelievry	分類進階功能包含 eCoupon 且提案單類型為 newProduct 時可選
        ''' 800	HomeStore	供應商啟用功能包含 deliveryByCvs 時可選        ''' </summary>
        Public Property shipType As Shiptype

        ''' <summary>
        ''' 賣場簡短說明 (必填●
        ''' 最多 5 條，每條最長 15 個字
        ''' 至少需填 1 條        '''         ''' ex : [我是簡短說明,我是簡短說明2]        ''' </summary>
        Public Property shortDescription() As List(Of String)

        ''' <summary>
        ''' 結構化資料屬性集 ID (必填●
        ''' 
        ''' ex : 000003326689
        ''' </summary>
        Public Property struDataAttrClusterId As String

        '''' <summary>
        '''' 商品保證 (必填●
        '''' </summary>
        'Public Property warranty As Warranty

        ''' <summary>
        ''' 商品詳情 (必填●
        ''' 為 HTML 內容
        ''' 	iframe URL 只允許 Youtube
        ''' 	image URL 只允許 yimg.com
        ''' 	image 不會再進行縮圖
        ''' 	proposal.reviewStatus 非 composing 時，為必填
        ''' 	
        ''' ex : table html /table
        ''' </summary>
        Public Property copy As String

        '''' <summary>
        '''' 品牌
        '''' 最長 20 個字
        '''' 
        '''' ex : 我是品牌
        '''' </summary>
        'Public Property brand As String

        '''' <summary>
        '''' 包裝完成後的商品高度
        '''' 單位為 cm，需為正整數
        '''' 若為配送方式為`快速到貨`或`直店配`時必填 (必填●
        '''' max 9999
        '''' 
        '''' ex : 77
        '''' </summary>
        'Public Property height As Integer

        '''' <summary>
        '''' 包裝完成後的商品長度
        '''' 單位為 cm，需為正整數
        '''' 若為配送方式為`快速到貨`或`直店配`時必填 (必填●
        '''' max 9999
        '''' 
        '''' ex : 55
        '''' </summary>
        'Public Property length As Integer

        '''' <summary>
        '''' 商品型號
        '''' 最長 20 個字
        '''' 
        '''' ex : 我是商品型號
        '''' </summary>
        'Public Property model As String
        '''' <summary>
        '''' 商品保存期限
        '''' 單位為天
        '''' range: [1-32767]
        '''' 配送方式shiptype為`快速到貨`可填，否則應為 null
        '''' 
        '''' ex : 56
        '''' </summary>
        'Public Property preserveDays As Integer
        '''' <summary>
        '''' 包裝完成後的商品寬度
        '''' 單位為 cm，需為正整數
        '''' 若為配送方式為`快速到貨`或`直店配`時必填
        '''' max 9999
        '''' 
        '''' ex : 88
        '''' </summary>
        'Public Property weight As Integer
        '''' <summary>
        '''' 包裝完成後的商品重量
        '''' 單位為 g，需為正整數
        '''' 若為配送方式為`快速到貨`或`直店配時`必填
        '''' max 2147483647
        '''' 
        '''' ex : 66
        '''' </summary>
        'Public Property width As Integer
        ''' <summary>
        ''' 商品屬性 (必填●        ''' </summary>
        Public Property specs() As List(Of Spec2) = New List(Of Spec2)
    End Class
#End Region

#Region "object(Product)(Attribute)"
    ''' <summary>
    ''' 商品規格表 (必填●
    '''被 ProposalModel 中被選中的 Attribute，不可再填入此欄位
    '''若規格為 structured data 中的選項
    '''	values 需符合 structured data constraint 限制 (radiobox/checkbox)
    '''	只能有一個 `自訂其他屬性`
    '''若規格為 `自訂`
    '''	values 只能有一個值
    '''	不允許重複 `自訂規格` 名稱
    '''	`自訂規格` 名稱不允許與 structured data 中的選項重複
    '''	`自訂規格` 名稱不允許與 `自訂屬性` 名稱重複
    ''' </summary>
    Public Class Attribute
        ''' <summary>
        ''' 屬性名稱 (必填●
        ''' 
        ''' ex : 中央處理器品牌
        ''' ex : 中央處理器型號
        ''' ex : 型號
        ''' ex : 晶片組
        ''' ex : 重量(kg)
        ''' </summary>
        <JsonProperty(PropertyName:="name")>
        Public Property name As String
        ''' <summary>
        ''' 屬性值 (必填●
        ''' 
        ''' ex : Intel
        ''' ex : G870
        ''' ex : Trey-Super-PC
        ''' ex : B75
        ''' ex : 27t
        ''' </summary>
        <JsonProperty(PropertyName:="values")>
        Public Property values() As List(Of String)
    End Class
#End Region

#Region "object(Product)(Models)"

    ''' <summary>
    ''' 屬性商品型號 (不一定要給
    ''' proposal type = 14 (updateVideo) 且非無屬性賣場時須提供 (必填●
    ''' </summary>
    Public Class Model
        ''' <summary>
        ''' 屬性值 (必填●
        ''' </summary>
        <JsonProperty(PropertyName:="items")>
        Public Property items() As List(Of Item)
        ''' <summary>
        ''' 商品影片 (必填●
        ''' </summary>
        <JsonProperty(PropertyName:="videos")>
        Public Property videos() As List(Of Video)
        ''' <summary>
        ''' 商品圖 (必填●
        ''' newListing/newProduct
        ''' 最多 10 張，需要為正方形，尺寸大於 1000^2 pixels 會被縮至 
        ''' 1000^2, 400^2, 250^2, 135^2 及 80^2 pixels、
        ''' 大於 400^2 pixels 會被縮至 400^2, 250^2, 135^2 及 80^2 pixels
        ''' 至少需要兩張主圖 (1000^2 pixels)，可增加 8 張副圖 (1000^2 Or 400^2 pixels)
        '''	updateImage
        '''	用於 proposal.listing.models 且 order = 1 時，可於各尺寸指定小圖 URL，未指定寬高的維度會是 1000x1000 圖檔自動縮圖
        '''	用於 proposal.listing.[additionalPurchase|complimentaries|selectComplimentaries]，規則同 newListing / newProduct
        ''' </summary>
        <JsonProperty(PropertyName:="images")>
        Public Property images() As List(Of Image)
        ''' <summary>
        ''' 第 1 層屬性的 spec
        ''' 需為 ProposalProductSpec 中 level=1 的 spec
        ''' 若為無屬性商品時為空, 有 1 層及以上屬性時必填 (必填●
        ''' 若 spec name 是從 structured data 中挑選，且 constraint type 為
        ''' radiobox 或 checkbox 時
        ''' 	values 一定要包含在 constraint 選項中
        '''		`自訂項目` 時，values 為 `其他`，自訂內容存放於 displayName
        '''	若 spec name 為自訂時
        '''	    `自訂項目` 的值存放於 spec.values
        '''	    displayName 需為必填，但不需與 `自訂項目` 的值一致
        ''' </summary>
        <JsonProperty(PropertyName:="spec")>
        Public Property spec As Spec
        ''' <summary>
        ''' 賣場顯示名稱，預設為規格名稱 (必填●
        ''' 若為無屬性商品時為空, 有 1 層及以上屬性時可填
        ''' 
        ''' ex : 極致簡約Dell2019
        ''' </summary>
        <JsonProperty(PropertyName:="displayName")>
        Public Property displayName As String
    End Class
#End Region
#Region "object(Product)(Models)(spec)"

    ''' <summary>
    ''' 第 1 層屬性的 spec
    ''' 需為 ProposalProductSpec 中 level=1 的 spec
    ''' 若為無屬性商品時為空, 有 1 層及以上屬性時必填 (必填●
    ''' 若 spec name 是從 structured(結構化大中小類) data 中挑選，且 constraint type 為
    ''' radiobox 或 checkbox 時
    ''' 	values 一定要包含在 constraint 選項中
    '''		`自訂項目` 時，values 為 `其他`，自訂內容存放於 displayName
    '''	若 spec name 為自訂時
    '''	    `自訂項目` 的值存放於 spec.values
    '''	    displayName 需為必填，但不需與 `自訂項目` 的值一致
    ''' </summary>
    Public Class Spec
        ''' <summary>
        ''' ex : 品牌
        ''' ex : 品牌
        ''' </summary> 
        <JsonProperty(PropertyName:="name")>
        Public Property name As String
        ''' <summary>
        ''' ex : Dell戴爾
        ''' ex : hp惠普
        ''' </summary>
        <JsonProperty(PropertyName:="values")>
        Public Property values() As List(Of String)
    End Class

#End Region
#Region "object(Product)(Models)(Items)"
    ''' <summary>
    ''' 屬性值 (必填●
    ''' </summary>
    Public Class Item
        '''' <summary>
        '''' 屬性商品供應商商品料號
        '''' 最長 40 個字
        '''' 
        '''' ex : 5566
        '''' </summary>
        'Public Property partNo As String
        '''' <summary>
        '''' 實際國際條碼
        '''' 限定為13碼或12碼 (12碼由 API 在前面補 0 )
        '''' 若為下列配送方式 (shipType)時則可填寫
        '''' 	1 (宅配)
        ''''     61 (集宅配)
        ''''     800 (直店配)
        '''' </summary>
        'Public Property barcode As String
        '''' <summary>
        '''' 進倉用國際條碼
        '''' 限定為13碼或12碼 (12碼由 API 在前面補 0 )
        '''' 
        '''' ex : 725272730706
        '''' </summary>
        'Public Property warehouseBarcode As String
        ''' <summary>
        ''' 第 2 層屬性的 spec
        ''' 需為 ProposalProductSpec 中 level=2 的 spec
        ''' 若為無屬性與 1 層屬性商品時為空, 為 2 層屬性商品時為必填
        ''' 
        ''' ex : 9785109946480
        ''' </summary>
        <JsonProperty(PropertyName:="spec")>
        Public Property spec As Spec1
        ''' <summary>
        ''' 賣場顯示名稱
        ''' 預設為規格名稱
        ''' 若為無屬性與 1 層屬性商品時為空, 為 2 層屬性商品時可填
        ''' 
        ''' ex : 卡其色
        ''' </summary>
        <JsonProperty(PropertyName:="displayName")>
        Public Property displayName As String
    End Class

#End Region
#Region "object(Product)(Models)(Item)(Spec)"
    ''' <summary>
    '''第 2 層屬性的 spec
    '''需為 ProposalProductSpec 中 level=2 的 spec
    '''若為無屬性與 1 層屬性商品時為空, 為 2 層屬性商品時為必填
    '''ex : 9785109946480
    ''' </summary>
    Public Class Spec1
        ''' <summary>
        ''' ex : 顏色        ''' </summary>
        <JsonProperty(PropertyName:="name")>
        Public Property name As String
        ''' <summary>
        ''' ex : 卡其        ''' </summary>
        <JsonProperty(PropertyName:="values")>
        Public Property values() As List(Of String)
    End Class
#End Region
#Region "object(Product)(Models)(Video)"
    ''' <summary>
    ''' 商品影片 (必填●
    ''' </summary>
    Public Class Video
        ''' <summary>
        ''' 影片 url
        ''' 若 FQDN 為 {s|ct}.yimg.com 或 edgecast-vod.yahoo.net，必需為 https 協定
        ''' 目前支援的 Video Codecs 請見列表 
        ''' https://docs.aws.amazon.com/en_us/mediaconvert/latest/ug/reference-codecs-containers-input.html
        ''' 
        ''' ex :
        ''' https://s.yimg.com/bp/Files/374d9974ab2cbce382e42724fede7aa07313cae6.qt
        ''' </summary>
        <JsonProperty(PropertyName:="url")>
        Public Property url As String
        ''' <summary>
        ''' 排列
        ''' 
        ''' ex : 1
        ''' </summary>
        <JsonProperty(PropertyName:="order")>
        Public Property order As Integer
    End Class

#End Region
#Region "object(Product)(Models)(Image)"
    Public Class Image
        ''' <summary>
        ''' 影片 url
        ''' 若 FQDN 為 {s|ct}.yimg.com 或 edgecast-vod.yahoo.net，必需為 https 協定
        ''' 目前支援的 Video Codecs 請見列表 
        ''' https://docs.aws.amazon.com/en_us/mediaconvert/latest/ug/reference-codecs-containers-input.html
        ''' 
        ''' ex : https://s.yimg.com/bp/Files/ba0b8bf005bab4e7cc8821afea217e342a1dfca3.png
        ''' 
        ''' </summary>
        <JsonProperty(PropertyName:="url")>
        Public Property url As String
        ''' <summary>
        ''' 排列
        ''' starts from 1
        ''' 
        ''' ex : 1
        ''' </summary>
        <JsonProperty(PropertyName:="order")>
        Public Property order As Integer
    End Class
#End Region

#Region "object(Product)(Shiptype)"

    ''' <summary>
    ''' 配送方式 (必填●
    ''' 1	Home	    預設可選
    ''' 61	Express24HR	附約資訊包含 warehouse 時可選    ''' 200	ESD	        分類進階功能包含 ESD 時可選    ''' 400	EDelievry	分類進階功能包含 eCoupon 且提案單類型為 newProduct 時可選
    ''' 800	HomeStore	供應商啟用功能包含 deliveryByCvs 時可選    ''' </summary>
    Public Class Shiptype
        ''' <summary>
        ''' 配送方式 (必填●
        ''' 1	Home	    預設可選 宅配(轉單/自出)
        ''' 61	Express24HR	附約資訊包含 warehouse 時可選 快速到貨(進倉)        ''' 200	ESD	        分類進階功能包含 ESD 時可選        ''' 400	EDelievry	分類進階功能包含 eCoupon 且提案單類型為 newProduct 時可選 電子禮券
        ''' 800	HomeStore	供應商啟用功能包含 deliveryByCvs 時可選 直店配(宅配+超取)        '''         ''' ex : 61        ''' </summary>
        <JsonProperty(PropertyName:="id")>
        Public Property id As Integer
    End Class

#End Region

    '#Region "object(Product)(Warranty)"

    '    ''' <summary>
    '    ''' 商品保證 (必填●
    '    ''' </summary>
    '    Public Class Warranty

    '        ''' <summary>
    '        ''' 保固期限 (必填●
    '        ''' 如果內容值為`無保固`則保固範圍及保固來源可不填，反之若為其他值則必填
    '        ''' 最長 20 個字
    '        ''' 
    '        ''' ex : 一個月
    '        ''' </summary>
    '        Public Property period As String

    '        ''' <summary>
    '        ''' 說明訊息整段描述
    '        ''' 最長 800 個字
    '        ''' 
    '        ''' ex : 保固說明文字
    '        ''' </summary>
    '        Public Property description As String

    '        ''' <summary>
    '        ''' 保固來源
    '        ''' none: 無保固
    '        ''' official: 原廠保固
    '        ''' retailer: 經銷保固
    '        ''' 若保固期限為`無保固`，只能為`none` (若有輸入會被取代)
    '        ''' 若保固期限不為`無保固`，預設為`official`
    '        ''' 
    '        ''' ex : official
    '        ''' </summary>
    '        Public Property handler As String
    '        ''' <summary>
    '        ''' 保固範圍
    '        ''' 最長 20 個字
    '        ''' 若保固期限為`無保固`，自動填入`無保固`
    '        ''' 
    '        ''' ex : 新品瑕疵
    '        ''' </summary>
    '        Public Property scope As String
    '    End Class
    '#End Region

#Region "object(Product)(Specs)"
    ''' <summary>
    ''' 商品屬性 (必填●    '''     ''' 此值可決定 1層 2層 屬性商品    ''' </summary>
    Public Class Spec2
        ''' <summary>
        ''' 屬性層級 (必填●
        ''' range: [1-2]
        ''' 
        ''' exe : 1
        ''' exe : 2
        ''' </summary>
        <JsonProperty(PropertyName:="level")>
        Public Property level As Integer
        ''' <summary>
        ''' 屬性名稱最長 30 個字 (必填●
        ''' 
        ''' exe : 品牌
        ''' exe : 顏色
        ''' </summary>
        <JsonProperty(PropertyName:="name")>
        Public Property name As String
    End Class
#End Region



#Region "object(Listing)"

    ''' <summary>
    ''' 賣場資訊 type 為 newListing 且 reviewStatus 非 composing 時必填 (必填●
    ''' </summary>
    Public Class Listing
        ''' <summary>
        ''' 商品目前的分類子類，往上追溯的子站要跟供應商有簽約的子站有交集 (必填●
        ''' ex : catItem10070
        ''' </summary>
        <JsonProperty(PropertyName:="catItemId")>
        Public Property catItemId As String
        ''' <summary>
        ''' 交貨期限 
        ''' 預設 normal
        ''' normal 正常交貨期
        ''' preOrder: 預購型商品
        ''' customized: 客製化商品
        ''' appointment: 客約送貨日
        ''' 
        ''' shipTypeId = 61
        ''' (集宅配)	if (product.isInstallRequired = true)
        ''' ? appointment :  normal
        ''' shipTypeId != 61
        ''' (非集宅配)	if category.functions contains
        ''' preOrderDelivery: normal, preOrder
        ''' customizedDelivery: normal, customized
        ''' appointmentDelivery: normal, appointment
        ''' 
        ''' 提案一般賣場且 reviewStatus 為 draft草案 時以上必填 (必填●
        ''' 
        ''' ex : appointment
        ''' </summary>
        <JsonProperty(PropertyName:="deliveryType")>
        Public Property deliveryType As String
        '''' <summary>
        '''' 特色標題，最長 20 個字
        '''' 
        '''' ex : 我是特色標題
        '''' </summary>
        'Public Property featureTitle As String
        ''' <summary>
        ''' 購物中心售價，到小數點兩位
        ''' range: [0-9999999]
        ''' rules:
        ''' 1.	cost (成本(含稅+運費)) 小於等於 price (購物中心售價) 小於等於 msrp (廠商建議價)
        ''' 2.	shipTypeId=800 (直店配) 時需 小於等於 20000
        ''' 提案一般賣場且 reviewStatus 為 draft 以上時必填 (必填●
        ''' 
        ''' 若"賣場毛利率 ((購物中心售價 - 成本) / 購物中心售價) 小於 子站毛利率"時，則
        ''' 1.	若有自動過審 (user.profile.toggles contains autoApproveListingOnOffShelve)時，API 會阻擋該 request
        ''' 2.	若無自動過審，僅檢查賣場毛利率需>=0
        ''' 
        ''' ex : 100.00
        ''' </summary>
        <JsonProperty(PropertyName:="price")>
        Public Property price As String
        ''' <summary>
        ''' 賣場網址，最長 25 個字
        ''' 只接受正/簡體中文、英文、數字、`-`，多個 `-` 會合併成一個，開頭不能是 `-`
        ''' 提案一般賣場且 reviewStatus 為 draft 以上時必填(必填●
        ''' 
        ''' ex : 我是商品名稱
        ''' </summary>
        <JsonProperty(PropertyName:="seoUrl")>
        Public Property seoUrl As String
    End Class
#End Region

End Class
#End Region


Public Class temporarily_header
#Region "YahooShoppingSCM_API_request (header_加密取得_sp cookie)"
    '依雅虎購物中心api_sign in_規格需求加密
    Public Shared Function temporarily_header()

        'HTTP_request需求包含4個 header (api-token、api-version、api-timesta、api-signture)與 Credential密文(加密後的cookie)
        '雅虎購物中心API_KEY查詢 : https://scm.monday.com.tw/ApprovalForm/Query/ApiKeyQuery.aspx

        'request實際欄位名稱為 api-timestamp 為Request發送當下的UnixTimestamp，例如1548225833，此Timestamp的有效期限為90秒
        Dim timestamp As String = Int((DateTime.UtcNow - New DateTime(1970, 1, 1, 0, 0, 0)).TotalSeconds + 0.5) '1573455721 
        'request實際欄位名稱為 api-token 為API Key查詢頁提供之Token
        Dim token As String = "Supplier_478"
        '供應商編號
        Dim supplierId As Integer = 478
        '為API Key查詢頁提供之KeyValue
        Dim secretKey As String = "yrsW8ukCXsEZOkKmegF7T2WrK0MTq9U2jH3DmSIod24="
        '為API Key查詢頁提供之KeyIV
        Dim iv As String = "MmThDVTcmRpN5jFgzxb+nQ=="
        '為API Key查詢頁提供之SaltKey
        Dim saltKey As String = "doTzTL6Ev0ttm2OF3kxpzloGTtxky1eI"
        'request實際欄位名稱為 api-Version 為API Key查詢頁提供之Version
        Dim Version As String = "1"

        '***** checked *****

        '***** Credential Plaintext 憑證文本 *****

        Dim cookie As JObject = New Newtonsoft.Json.Linq.JObject
        cookie.Add("supplierId", supplierId)
        'Dim plaintext As String = cookie.ToString
        Dim plaintext As String = "{" + Chr(34) + "supplierId" + Chr(34) + ":478}"

        '***** checked *****

        '***** Credential Signature 憑證密文 *****
        '參考文章 : https://stackoverflow.com/questions/5987186/aes-encrypt-string-in-vb-net
        '參考文章 : https://dotblogs.com.tw/yc421206/archive/2012/04/18/71609.aspx
        '參考文章 : https://stackoverflow.com/questions/723129/using-aescryptoserviceprovider-in-vb-net
        '參考文章 : https://stackoverflow.com/questions/3962900/how-do-i-encrypt-a-string-in-vb-net-using-rijndaelmanaged-and-using-pkcs5-paddi
        'AES / CBC / PKCS5Padding 加密方式
        '此步驟使用到 supplierId / secretKey / iv

        Dim aes As AesCryptoServiceProvider = New AesCryptoServiceProvider()

        aes.Key = Convert.FromBase64String(secretKey)
        aes.IV = Convert.FromBase64String(iv)
        aes.Mode = CipherMode.CBC
        aes.Padding = PaddingMode.PKCS7

        'Dim encryptor = aes.CreateEncryptor()
        'Dim encrypted = encryptor.TransformFinalBlock(Encoding.UTF8.GetBytes(plaintext), 0, Encoding.UTF8.GetBytes(plaintext).Length)
        'aes.Clear()
        Dim ms As MemoryStream = New MemoryStream()
        Dim cs As CryptoStream = New CryptoStream(ms, aes.CreateEncryptor(), CryptoStreamMode.Write)
        cs.Write(Encoding.UTF8.GetBytes(plaintext), 0, Encoding.UTF8.GetBytes(plaintext).Length)
        cs.FlushFinalBlock()
        Dim encrypted = ms.ToArray()

        Dim ciphertext As String = ""
        ciphertext = Convert.ToBase64String(encrypted)

        '***** checked *****

        '***** Credential Signature 憑證簽章 *****
        '參考文章 : https://kknews.cc/zh-tw/code/33bzv9y.html
        'hmacsha512 加密方式
        '此步驟使用到 timestamp / token / saltKey / secretKey

        Dim signatureSource As String = String.Format("{0}{1}{2}{3}", timestamp, token, saltKey, ciphertext)

        Dim utf8 As UTF8Encoding = New UTF8Encoding()
        Dim keyByte As Byte() = utf8.GetBytes(secretKey)
        Dim HMACSHA512 As HMACSHA512 = New HMACSHA512(keyByte)
        Dim messageBytes As Byte() = utf8.GetBytes(signatureSource)
        Dim hashmessage As Byte() = HMACSHA512.ComputeHash(messageBytes)

        Dim builder As New StringBuilder(hashmessage.Length * 2)
        For Each data As Byte In hashmessage
            builder.Append(Convert.ToString(data, 16).PadLeft(2, "0"c).PadRight(2, " "c))
        Next

        Dim metadata As Byte() = Encoding.UTF8.GetBytes(builder.ToString)

        Dim signaturebyte As Byte() = Encoding.Convert(Encoding.UTF8, Encoding.GetEncoding("iso-8859-1"), metadata)
        Dim signature As String = System.Text.Encoding.Default.GetString(signaturebyte)

        '***** 將包裹塞入封包header *****
        '實作 HttpWebRequest
        Dim request As HttpWebRequest = WebRequest.Create("https://tw.supplier.yahoo.com/api/spa/v1/signIn")
        request.CookieContainer = New CookieContainer()
        request.Method = "POST"
        request.Headers.Add("api-token", token)
        request.Headers.Add("api-keyversion", Version)
        request.Headers.Add("api-timestamp", timestamp)
        request.Headers.Add("api-signature", signature)
        request.ContentType = "application/json"
        request.Headers.Add("charset", "utf-8")
        '禁止轉址
        request.AllowAutoRedirect = False

        '內容轉為資料流
        Dim st As Stream = request.GetRequestStream()
        Dim byteArray As Byte() = Encoding.Default.GetBytes(ciphertext)
        st.Write(byteArray, 0, byteArray.Length)

        '執行HttpWebRequest
        Dim response As HttpWebResponse = request.GetResponse()
        '擷取response cookie string
        '參考 http://storynsong01.pixnet.net/blog/post/116435414-%E3%80%90vba%E3%80%91%E5%B8%B8%E7%94%A8vb%E5%AD%97%E4%B8%B2%E8%99%95%E7%90%86%E5%87%BD%E6%95%B8
        Dim _sp As String = response.Cookies.Item("_sp").ToString
        _sp = Microsoft.VisualBasic.Mid(_sp, 5, _sp.Length)
        '釋放response
        response.Close()
        '回傳依header計算之CookieCollection
        Return (timestamp + "," + signature)

    End Function

#End Region
End Class

```

```text
<%@ WebHandler Language="VB" Class="ajax_Get_category" %>

Imports System
Imports System.Web
Imports System.Web.UI

Public Class ajax_Get_category : Implements IHttpHandler
    Public attrclass As String = HttpContext.Current.Request("attrclass")
    Public catItemId As String = HttpContext.Current.Request("catItemId")
    Public level1 As String = HttpContext.Current.Request("level1")
    Public level2 As String = HttpContext.Current.Request("level2")


    Public Sub ProcessRequest(ByVal context As HttpContext) Implements IHttpHandler.ProcessRequest

        '小類觸發屬性 AJAX
        If catItemId <> "" Or catItemId <> Nothing Then

            Select Case attrclass
                Case "level1"
                    '查屬性
                    Dim attrbrandsql = "SELECT * FROM YahooshoppingSCM_API_struDataAttrClusters WITH (NOLOCK) WHERE catItemId='{0}' AND Attrrequired = 'True'"
                    attrbrandsql = String.Format(attrbrandsql, catItemId)
                    Dim dt = EC.DB.ExecuteDataTable(attrbrandsql)

                    '轉為選項
                    Dim htmltext = "<option value=''>未選擇</option>"

                    For num As Integer = 0 To dt.Rows.Count - 1 Step 1
                        htmltext += "<option value='" + dt.Rows.Item(num).Item("Attrname") + "'>" + dt.Rows.Item(num).Item("Attrname") + "</option>"
                    Next

                    context.Response.ContentType = "text/plain"
                    context.Response.Write(htmltext)

                Case "level2"
                    '查屬性
                    Dim attrbrandsql = "SELECT * FROM YahooshoppingSCM_API_struDataAttrClusters WITH (NOLOCK) WHERE catItemId='{0}' AND Attrrequired = 'True' AND Attrname <> '{1}'"
                    attrbrandsql = String.Format(attrbrandsql, catItemId, level1)
                    Dim dt = EC.DB.ExecuteDataTable(attrbrandsql)

                    '轉為選項
                    Dim htmltext = "<option value=''>未選擇</option>"
                    For num As Integer = 0 To dt.Rows.Count - 1 Step 1
                        htmltext += "<option value='" + dt.Rows.Item(num).Item("Attrname") + "'>" + dt.Rows.Item(num).Item("Attrname") + "</option>"
                    Next

                    context.Response.ContentType = "text/plain"
                    context.Response.Write(htmltext)


                Case "required"

                    '查必填屬性
                    '必填非自定義屬性
                    Dim attrbrandsql = "SELECT * FROM YahooshoppingSCM_API_struDataAttrClusters WITH (NOLOCK) WHERE catItemId='{0}' AND Attrrequired = 'True' AND Attrtype <> 'text'"
                    attrbrandsql = String.Format(attrbrandsql, catItemId)
                    Dim dt = EC.DB.ExecuteDataTable(attrbrandsql)

                    Dim attrrequireds = "<div id='requiredattr1' name='requiredattr1'>"
                    For num1 As Integer = 0 To dt.Rows.Count - 1 Step 1

                        Dim dtstring = dt.Rows.Item(num1).Item("Attrname").ToString
                        attrrequireds += "<input style='border: 0' id='attrname{1}' name='attrname{2}' readonly='readonly' value='{0}' /> : <select id='attrnoncustom{1}' name='attrnoncustom{2}' required='required'><option value=''>未選擇</option>"

                        attrrequireds = String.Format(attrrequireds, dtstring, num1, num1)

                        '轉為目標格式
                        Dim attrs = dt.Rows.Item(num1).Item("Attrvalues").ToString
                        Dim clear() As Char = {"[", "]"}
                        attrs = attrs.Trim(clear)
                        attrs = attrs.Replace("""", Nothing)
                        Dim requireds() = attrs.Split(",")

                        '轉為選擇與選項
                        For num2 As Integer = 0 To requireds.Count - 1 Step 1
                            attrrequireds += "<option value='" + requireds(num2) + "'>" + requireds(num2) + "</option>"
                        Next
                        attrrequireds += "</select></br>"
                    Next
                    attrrequireds += "</div>"

                    '必填自定義屬性

                    Dim attrbrandsql2 = "SELECT * FROM YahooshoppingSCM_API_struDataAttrClusters WITH (NOLOCK) WHERE catItemId='{0}' AND Attrrequired = 'True' AND Attrtype = 'text'"
                    attrbrandsql2 = String.Format(attrbrandsql2, catItemId)
                    Dim dt2 = EC.DB.ExecuteDataTable(attrbrandsql2)

                    attrrequireds += "</br></br>"
                    attrrequireds += "<div id='requiredattr2' name='requiredattr2'>"
                    For num1 As Integer = 0 To dt2.Rows.Count - 1 Step 1

                        Dim dtstring = dt2.Rows.Item(num1).Item("Attrname").ToString
                        attrrequireds += "<input style='border: 0' id='textattrname{1}' name='textattrname{2}' readonly='readonly' value='{0}' required='required'/> : <input id='attrcustom{1}' name='attrcustom{2}' required='required' />"

                        attrrequireds = String.Format(attrrequireds, dtstring, num1, num1)

                        attrrequireds += "</br>"
                    Next
                    attrrequireds += "</div>"

                    context.Response.ContentType = "text/plain"
                    context.Response.Write(attrrequireds)


                 '屬性ID
                Case "struDataAttrClusterId"

                    Dim struDataAttrClusterIdsql = "SELECT struDataAttrClusterId FROM YahooshoppingSCM_API_struDataAttrClusters WITH (NOLOCK) WHERE catItemId='{0}'"
                    struDataAttrClusterIdsql = String.Format(struDataAttrClusterIdsql, catItemId)
                    Dim dt2 = EC.DB.ExecuteDataTable(struDataAttrClusterIdsql)

                    context.Response.ContentType = "text/plain"
                    context.Response.Write(dt2.Select().FirstOrDefault.Item("struDataAttrClusterId").ToString())


            End Select

        End If

    End Sub

    Public ReadOnly Property IsReusable() As Boolean Implements IHttpHandler.IsReusable
        Get
            Return False
        End Get
    End Property

End Class
```

```text
<%@ WebHandler Language="VB" Class="ajax_Get_category" %>

Imports System
Imports System.Web
Imports System.Web.UI

Public Class ajax_Get_category : Implements IHttpHandler
    Public subStationId As String = HttpContext.Current.Request("subStationId")
    Public categoryId As String = HttpContext.Current.Request("categoryId")

    Public yahooCategorycats As String
    Public yahooCategorycatitems As String

    Public Sub ProcessRequest(ByVal context As HttpContext) Implements IHttpHandler.ProcessRequest

        '大類觸發中類 AJAX
        If subStationId <> "" Or subStationId <> Nothing Then

            '用於結構化雅虎商品類別 

            Dim APICategorydtSql = String.Format("SELECT categoryId,categoryIdname FROM YahooshoppingSCM_API_Category WITH(NOLOCK) WHERE subId='{0}' GROUP BY categoryId,categoryIdname", subStationId)
            Dim APICategorydt = EC.DB.ExecuteDataTable(APICategorydtSql)

            yahooCategorycats += "<option value=''>未選擇</option>"

            For num As Integer = 0 To APICategorydt.Rows.Count - 1 Step 1
                yahooCategorycats += "<option value='" + APICategorydt.Rows.Item(num).Item(0) + "'>" + APICategorydt.Rows.Item(num).Item(1) + "</option>"
            Next

            context.Response.ContentType = "text/plain"
            context.Response.Write(yahooCategorycats)

        End If

        '中類觸發小類 AJAX
        If categoryId <> "" Or categoryId <> Nothing Then

            '用於結構化雅虎商品類別 

            yahooCategorycatitems += "<option value=''>未選擇</option>"

            Dim APICategorydtSql = String.Format("SELECT catItemId,catItemIdname FROM YahooshoppingSCM_API_Category WITH(NOLOCK) WHERE categoryId='{0}' GROUP BY catItemId,catItemIdname", categoryId)
            Dim APICategorydt = EC.DB.ExecuteDataTable(APICategorydtSql)

            For num As Integer = 0 To APICategorydt.Rows.Count - 1 Step 1
                yahooCategorycatitems += "<option value='" + APICategorydt.Rows.Item(num).Item(0) + "'>" + APICategorydt.Rows.Item(num).Item(1) + "</option>"
            Next

            context.Response.ContentType = "text/plain"
            context.Response.Write(yahooCategorycatitems)

        End If

    End Sub

    Public ReadOnly Property IsReusable() As Boolean Implements IHttpHandler.IsReusable
        Get
            Return False
        End Get
    End Property

End Class
```

```text
<%@ Page Language="VB" AutoEventWireup="false" MasterPageFile="~/MasterPage.master" CodeFile="Form_CRUD.aspx.vb" Inherits="mng_product_list_Form" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" runat="Server">
    <script src="/lib/ckeditor_3.6.2/ckeditor.js" type="text/javascript"></script>
    <script src="/lib/ckeditor_3.6.2/config.js" type="text/javascript"></script>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="ContentPlaceHolder1" runat="Server">

    <form id="ff" action="Form_CRUD_Save.aspx?PrgID=<%=PrgID%>" enctype="multipart/form-data" method="post" style2="padding: 10px 20px 10px 40px;">
        <input type="hidden" name="id" id="id" value="<%=_ID%>" />
        <input type="hidden" name="cno" id="cno" value="<%=_ID%>" />
        <input type="hidden" name="action" id="action" value="" />
        <input type="hidden" name="cost" id="cost" value="<%=tb.cost%>" />
        <input type="hidden" name="online" id="online" value="<%=tb.OnLine%>" />
        <input type="hidden" name="spicalprice" id="spicalprice" value="<%=tb.spicalprice%>" />
        <input type="hidden" name="saleprice" id="saleprice" value="<%=tb.saleprice%>" />
        <input type="hidden" name="BonusPoint" id="BonusPoint" value="<%=tb.BonusPoint%>" />
        <input type="hidden" name="list_max_buy" id="list_max_buy" value="<%=tb.List_max_buy%>" />
        <input type="hidden" name="list_max_buy_tot" id="list_max_buy_tot" value="<%=tb.list_max_buy_tot%>" />

        <%-- 新欄位 --%>
        <input type="hidden" name="ProductNo" id="ProductNo" value="<%=ProductNo%>" />
        <input type="hidden" name="attrnoncustomcount" id="attrnoncustomcount" value="" required="required"/>
        <input type="hidden" name="attrcustomcount" id="attrcustomcount" value="" required='required'/>
        <input type="hidden" name="struDataAttrClusterId" id="struDataAttrClusterId" value="<%=struDataAttrClusterId%>"" />




        <table border="1" width="100%" class="doc-table">
            <%If _ID > 0 Then%>
            <tr>
                <td colspan="2" style="background-color: #faf5dd" align="right">
                    <a href="<%=tb.Moreinfo_Page_URL%>" target="_blank">開啟前台產品頁面</a>
                </td>
            </tr>
            <%End If%>
            <tr>
                <td colspan="2" style="background-color: #faf5dd">
                    <div class="cus_accordion" id="div_prod">
                        <div class="expanded" style="float: left"></div>
                        既有EC欄位 
                <div class="expanded" style="float: right"></div>
                    </div>
                </td>
            </tr>
            <tr class="div_prod">
                <td colspan="2">
                    <table border="0" width="100%">
                        <tr>
                            <td class="bg" width="80">購物中心售價:</td>
                            <td>
                                <input readonly="readonly" type="text" id="price" name="price" value="<%=tb.SpicalPrice%>" size="20" maxlength="20" />
                            </td>
                            <td class="bg">SEO商品名稱:</td>
                            <td>
                                <input readonly="readonly" type="text" id="seoUrl" name="seoUrl" value="<%=tb.ProductName%>"  />
                            </td>
                        </tr>

                        <tr>
                            <td class="bg">成本(含稅+運費):</td>
                            <td>
                                <input readonly="readonly" type="text" id="cost" name="cost" value="<%=tb.Cost%>" size="25" maxlength="20" />
                            </td>
                            <td class="bg" width="100">廠商建議價:</td>
                            <td>
                                <input readonly="readonly" type="text" id="msrp" name="msrp" value="<%=tb.SpicalPrice%>" size="25" maxlength="50" />
                            </td>
                        </tr>
                        <tr>
                            <td class="bg">商品名稱:</td>

                            <td>
                                <input readonly="readonly" type="text" id="name" name="name" value="<%=tb.ProductName%>" size="25" maxlength="50" />
                            </td>
                    </table>
                </td>
            </tr>
            

            <tr>
                <td colspan="2" style="background-color: #faf5dd">
                    <div class="cus_accordion" id="div_prod_info">
                        <div class="expanded" style="float: left"></div>
                        雅虎購物中心新增欄位
                <div class="expanded" style="float: right"></div>
                    </div>
                </td>
            </tr>
            <tr class="div_prod_info">
                <td colspan="2">
                    <table border="0" width="100%">
                        <tr>
                            <td class="bg" width="120">申請人:</td>
                            <td>
                                <input type="text" id="applicant" name="applicant" size="20" maxlength="20" value="<%=yahoolist.Item("applicant").ToString%>" required='required'/>
                            </td>
                        </tr>
                        <tr>
                            <td class="bg">內容級別:</td>
                            <td colspan="4" style="color: red;">(若為未滿18歲青少年不能購買商品，請選擇限制級)<br />
                                <select name="contentRating" id="contentRating" required="required">
                                    <%=contentRatings%>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="bg">賣場顯示名稱:</td>
                            <td colspan="4">
                                <br />
                                <input type="text" id="displayName" name="displayName" size="20" maxlength="20" value="<%=yahoolist.Item("displayName").ToString%>" required='required'/>
                            </td>
                        </tr>
                        <tr>
                            <td class="bg">賣場簡短說明1:</td>
                            <td colspan="4" style="color: red;">至少需填說明1<br />
                                <input type="text" id="shortDescription_1" name="shortDescription_1" size="20" maxlength="20" value="<%=yahoolist.Item("shortDescription_1").ToString%>" required='required'/>
                            </td>
                        </tr>
                        <tr>
                            <td class="bg">賣場簡短說明2:</td>
                            <td colspan="4">
                                <br />
                                <input type="text" id="shortDescription_2" name="shortDescription_2" size="20" maxlength="20" value="<%=yahoolist.Item("shortDescription_2").ToString%>" />
                            </td>
                        </tr>
                        <tr>
                            <td class="bg">賣場簡短說明3:</td>
                            <td colspan="4">
                                <br />
                                <input type="text" id="shortDescription_3" name="shortDescription_3" size="20" maxlength="20" value="<%=yahoolist.Item("shortDescription_3").ToString%>" />
                            </td>
                        </tr>
                        <tr>
                            <td class="bg">賣場簡短說明4:</td>
                            <td colspan="4">
                                <br />
                                <input type="text" id="shortDescription_4" name="shortDescription_4" size="20" maxlength="20" value="<%=yahoolist.Item("shortDescription_4").ToString%>" />
                            </td>
                        </tr>
                        <tr>
                            <td class="bg">賣場簡短說明5:</td>
                            <td colspan="4">
                                <br />
                                <input type="text" id="shortDescription_5" name="shortDescription_5" size="20" maxlength="20" value="<%=yahoolist.Item("shortDescription_5").ToString%>" />
                            </td>
                        </tr>

                    </table>
                </td>
            </tr>
            <tr>
                <td colspan="2" style="background-color: #faf5dd">
                    <div class="cus_accordion" id="div_setting">
                        <div class="expanded" style="float: left"></div>
                        雅虎類別設定 : <%=yahooCategorycatstext %>
                <div class="expanded" style="float: right"></div>
                    </div>
                </td>
            </tr>
            <tr class="div_setting">
                <td colspan="2">
                    <table border="0" width="100%" class2="doc-table">
                        <tr>
                            <td class="bg" width="80">所屬分類:</td>
                            <td colspan="5" >
                                <select name="subStationId" id="subStationId" required="required">
                                    <%=yahooCategorysubs%>
                                </select>
                                <select name="categoryId" id="categoryId" required="required">
                                    <%=yahooCategorycats%>
                                </select>
                                <select name="catItemId" id="catItemId" required="required">
                                    <%=yahooCategorycatitems%>
                                </select>
                          
                            </td>
                        </tr>

                    </table>
                </td>
            </tr>
            <tr>
                <td colspan="2" style="background-color: #faf5dd">
                    <div class="cus_accordion" id="div_attrsetting">
                        <div class="expanded" style="float: left"></div>
                        結構化屬性設定 : <font style="color:red">顯示屬性都是必填屬性，如要更改請依序由大中小類屬性更改</font>
                <div class="expanded" style="float: right"></div>
                    </div>
                </td>
            </tr>
            <tr class="div_attrsetting">
                <td colspan="2">
                    <table border="0" width="100%" class2="doc-table">
                        <tr>
                            <td class="bg" width="100">level 1 屬性:</td>
                            <td colspan="5">
                                <select name="level1" id="level1" required="required">
                                    <option value="<%=level1%>"><%=level1%></option>
                                </select> : <span style="color:white">___</span>屬性別稱 ↓
                                <input id='lv1displayname' name='lv1displayname' value="<%=lv1displayname %>" required='required'/>
                            </td>
                            
                            <td class="bg" width="100">level 2 屬性:</td>
                            <td colspan="5">
                                <select name="level2" id="level2" required="required">
                                    <option value="<%=level2%>"><%=level2%></option>
                                </select> : <span style="color:white">___</span>屬性別稱 ↓
                                <input id='lv2displayname' name='lv2displayname' value="<%=lv2displayname %>" required='required'/>
                            </td>
                        </tr>

                      
                         <tr>
                            <td class="bg" width="100">必填其餘屬性:</td>
                            <td colspan="10" name="requiredattr" id="requiredattr">
                                <div id="requiredattr1" name="requiredattr1">
                                <%=attrnoncustom%>
                                    </div>
                                </br></br>
                                <div id="requiredattr2" name="requiredattr2">
                                <%=attrcustom%>
                                    </div>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td colspan="2" style="background-color: #faf5dd">
                    <div class="cus_accordion" id="div_image">
                        <div class="expanded" style="float: left"></div>
                        圖檔設定
                <div class="expanded" style="float: right"></div>
                    </div>
                </td>
            </tr>
            <tr class="div_image">
                <td colspan="2">
                    <table border="0" width="100%">
                        <tr>
                            <td class="bg" width="80"><span class="mustinput">*</span>原圖:<br />
                                500*500(以上)</td>
                            <td>
                                <font color="red">如無大/小圖,上傳原圖後將自動產生</font><br />
                                <%If Not String.IsNullOrWhiteSpace(tb.CategoryO) Then%>
                                <input type="text" name="CategoryO_old" id="CategoryO_old" value="<%=tb.CategoryO%>" size="50" />
                                <a href="<%=EC.mng.Info.Eclife_HomeURL & tb.CategoryO%>" target="_blank">View</a>
                                <label>
                                    <input type="checkbox" name="CategoryO_delete" value="yes" />刪</label>
                                <br />
                                <%end If%>
                                <input type="file" name="CategoryO" id="CategoryO" size="50" />
                            </td>
                        </tr>
                        <tr>
                            <td class="bg" width="80">大圖:<br />
                                500*500</td>
                            <td>
                                <%If Not String.IsNullOrWhiteSpace(tb.CategoryA) Then%>
                                <input type="text" name="CategoryA_old" id="CategoryA_old" value="<%=tb.CategoryA%>" size="50" />
                                <a href="<%=EC.mng.Info.Eclife_HomeURL & tb.CategoryA%>" target="_blank">View</a>
                                <label>
                                    <input type="checkbox" name="CategoryA_delete" value="yes" />刪</label>
                                <br />
                                <%end If%>
                                <input type="file" name="CategoryA" id="CategoryA" size="50" />
                            </td>
                        </tr>
                        <tr>
                            <td class="bg">小圖:<br />
                                300*300</td>
                            <td>
                                <%If Not String.IsNullOrWhiteSpace(tb.CategoryB) Then%>
                                <input type="text" name="CategoryB_old" id="CategoryB_old" value="<%=tb.CategoryB%>" size="50" />
                                <a href="<%=EC.mng.Info.Eclife_HomeURL & tb.CategoryB%>" target="_blank">View</a>
                                <label>
                                    <input type="checkbox" name="CategoryB_delete" value="yes" />刪</label>
                                <br />
                                <%end if%>
                                <input type="file" name="CategoryB" id="CategoryB" size="50" />
                            </td>
                        </tr>
                        <tr>
                            <td class="bg">廣告圖:<br />
                                500*500(.png)</td>
                            <td>
                                <%If Not String.IsNullOrWhiteSpace(tb.CategoryE) Then%>
                                <input type="text" name="CategoryE_old" id="CategoryE_old" value="<%=tb.CategoryE%>" size="50" />
                                <a href="<%=EC.mng.Info.Eclife_HomeURL & tb.CategoryE%>" target="_blank">View</a>
                                <label>
                                    <input type="checkbox" name="CategoryE_delete" value="yes" />刪</label>
                                <br />
                                <%end If%>
                                <input type="file" name="CategoryE" id="CategoryE" size="50" />
                            </td>
                        </tr>

                        <tr style="display: none">
                            <td class="bg">(1)相關圖片:</td>
                            <td>
                                <%If Not String.IsNullOrWhiteSpace(tb.Related1) Then%>
                                <input type="text" name="Related1_old" id="Related1_old" value="<%=tb.Related1%>" size="50" />
                                <a href="<%=EC.mng.Info.Eclife_HomeURL & tb.Related1%>" target="_blank">View</a>
                                <label>
                                    <input type="checkbox" name="Related1_delete" value="yes" />刪</label>
                                <br />
                                <%end if%>
                                <input type="file" name="Related1" id="Related1" size="50" />
                            </td>
                        </tr>
                        <tr style="display: none">
                            <td class="bg">(2)相關圖片:</td>
                            <td>
                                <%If Not String.IsNullOrWhiteSpace(tb.Related2) Then%>
                                <input type="text" name="Related2_old" id="Related2_old" value="<%=tb.Related2%>" size="50" />
                                <a href="<%=EC.mng.Info.Eclife_HomeURL & tb.Related2%>" target="_blank">View</a>
                                <label>
                                    <input type="checkbox" name="Related2_delete" value="yes" />刪</label>
                                <br />
                                <%end if%>
                                <input type="file" name="Related2" id="Related2" size="50" />
                            </td>
                        </tr>
                        <tr style="display: none">
                            <td class="bg">(3)相關圖片:</td>
                            <td>
                                <%If Not String.IsNullOrWhiteSpace(tb.Related3) Then%>
                                <input type="text" name="Related3_old" id="Related3_old" value="<%=tb.Related3%>" size="50" />
                                <a href="<%=EC.mng.Info.Eclife_HomeURL & tb.Related3%>" target="_blank">View</a>
                                <label>
                                    <input type="checkbox" name="Related3_delete" value="yes" />刪</label>
                                <br />
                                <%end if%>
                                <input type="file" name="Related3" id="Related3" size="50" />
                            </td>
                        </tr>

                        <tr>
                            <td class="bg">規格檔(PDF):</td>
                            <td>
                                <table border="0" width="100%">
                                    <tr>
                                        <td>
                                            <input type="radio" name="PDF_Mode" value="1" <%=IIf(tb.PDF_Mode = "1" And Not String.IsNullOrWhiteSpace(tb.URL_PDF), "checked", "")%> />
                                            URL:<input type="text" size="40" value="<%=tb.URL_PDF%>" name="URL_PDF" id="URL_PDF">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="radio" name="PDF_Mode" value="0" <%=IIf(tb.PDF_Mode = "0" And Not String.IsNullOrWhiteSpace(tb.FILE_PDF), "checked", "")%> />
                                            檔案:
                                    <%If Not String.IsNullOrWhiteSpace(tb.FILE_PDF) Then%>
                                            <input type="text" name="File_PDF_old" id="File_PDF_old" value="<%=tb.FILE_PDF%>" size="50" />
                                            <a href="<%=EC.mng.Info.Eclife_HomeURL & tb.FILE_PDF%>" target="_blank">View</a>
                                            <label>
                                                <input type="checkbox" name="File_PDF_delete" value="yes" />刪</label>
                                            <br />
                                            <%end if%>
                                            <input type="file" name="File_PDF" id="File_PDF" size="50" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>

            <tr>
                <td colspan="2" align="center">

                    <%-- 2015-04-20 小葉 從主頁移至表單的 --%>
                    <%If EC.mng.Login.ISDeveloper Or (_ID > 0 And prglimit.Modify) Then%>
                    <%If tb.NG = 2 Then%>
                    <a href="#" onclick="javascript:openform_NgFree(<%=tb.cno%>);" class="easyui-linkbutton">福利品</a>
                    <%Else %>
                    <%--<a href="#" onclick="javascript:ProdToNG(<%=tb.cno%>);" class="easyui-linkbutton" >轉NG</a>--%>
                    <%End If%>
                    <%end if %>
<%--                    <%If _ID > 0 And (EC.mng.Login.ISDeveloper Or prglimit.Delete) Then%>
                    <a href="#" onclick="javascript:del(<%=_ID%>);" class="easyui-linkbutton" icon="icon-cancel">刪除</a>
                    <%End If%>--%>
                    <%If EC.mng.Login.ISDeveloper Or (_ID = 0 And prglimit.Add) Or (_ID > 0 And prglimit.Modify) Then%>
                    <%--<a href="#" onclick="getlengthandsubmit()" class="easyui-linkbutton" icon="icon-ok">儲存</a>--%>
                    <input type="submit" onclick="getlengthandsubmit()" class="easyui-linkbutton" icon="icon-ok"/>
                    <%End If%>
                    <a href="#" onclick="javascript:closeme();" class="easyui-linkbutton" icon="icon-cancel">取消</a>
                </td>
            </tr>
        </table>
    </form>
    <script>
        //AJAX大類連動中類
        $("#subStationId").on("change", function(){

            //alert($("#subStationId").val());
            $("#categoryId").find("option:selected").text("");
            $("#categoryId").empty();
            $("#catItemId").find("option:selected").text("");
             $("#catItemId").empty();
            $("#brandname").find("option:selected").text("");
            $("#brandname").empty();
            $("#level1").find("option:selected").text("");
             $("#level1").empty();
             $("#level2").find("option:selected").text("");
            $("#level2").empty();
            $("#requiredattr").find("option:selected").text("");
            $("#requiredattr").empty();
            var cats;
            $.ajax({
                type: 'POST',
                async: false,  //使用同步
                url: "/mng/Product/list/yahooshoppingscm/ajax_Get_category.ashx",
                data: 'subStationId=' + $("#subStationId").val() ,
                dataType: "text",
                success: function (info) {
                    
                    cats = info
                    console.log(info)
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    //var message = '轉資料時發生錯誤';
                    //alert(message);    //提示視窗
                    alert(XMLHttpRequest+textStatus+errorThrown+'，AJAX失敗')
                }
            })

            $("#categoryId").html(cats);
            
        });
        //AJAX中類連動小類
         $("#categoryId").on("change", function(){

            //alert($("#subStationId").val());
            $("#catItemId").find("option:selected").text("");
             $("#catItemId").empty();
             $("#brandname").find("option:selected").text("");
             $("#brandname").empty();
             $("#level1").find("option:selected").text("");
             $("#level1").empty();
             $("#level2").find("option:selected").text("");
             $("#level2").empty();
             $("#requiredattr").find("option:selected").text("");
            $("#requiredattr").empty();
            var catitems;
            $.ajax({
                type: 'POST',
                async: false,  //使用同步
                url: "/mng/Product/list/yahooshoppingscm/ajax_Get_category.ashx",
                data: 'categoryId=' + $("#categoryId").val() ,
                dataType: "text",
                success: function (info) {
                    
                    catitems = info
                    console.log(info)
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    //var message = '轉資料時發生錯誤';
                    //alert(message);    //提示視窗
                    alert(XMLHttpRequest+textStatus+errorThrown+'，AJAX失敗')
                }
            })

            $("#catItemId").html(catitems);
            
         });





        //AJAX小類連動屬性 - level1
         $("#catItemId").on("change", function(){

            //alert($("#subStationId").val());
             $("#level1").find("option:selected").text("");
             $("#level1").empty();
             $("#level2").find("option:selected").text("");
             $("#level2").empty();
             $("#requiredattr").find("option:selected").text("");
            $("#requiredattr").empty();
             
            var attrs;
            $.ajax({
                type: 'POST',
                async: false,  //使用同步
                url: "/mng/Product/list/yahooshoppingscm/ajax_Get_attributes.ashx",
                data: 'catItemId=' + $("#catItemId").val()+'&attrclass=level1' ,
                dataType: "text",
                success: function (info) {
                    
                    attrs = info
                    console.log(info)
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    //var message = '轉資料時發生錯誤';
                    //alert(message);    //提示視窗
                    alert('此小類無品牌屬性確定選取?')
                }
            })
             $("#level1").html(attrs);
        
            
         });

        //AJAX小類連動屬性 - level2
         $("#level1").on("change", function(){

            //alert($("#subStationId").val());
           
            $("#level2").find("option:selected").text("");
             $("#level2").empty();
             $("#requiredattr").find("option:selected").text("");
            $("#requiredattr").empty();
            var attrs;
            $.ajax({
                type: 'POST',
                async: false,  //使用同步
                url: "/mng/Product/list/yahooshoppingscm/ajax_Get_attributes.ashx",
                data: 'catItemId=' + $("#catItemId").val()+'&attrclass=level2&level1='+$("#level1").val() ,
                dataType: "text",
                success: function (info) {
                    
                    attrs = info
                    console.log(info)
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    //var message = '轉資料時發生錯誤';
                    //alert(message);    //提示視窗
                    alert('此小類無品牌屬性確定選取?')
                }
            })
      
            $("#level2").html(attrs);
            
         });

        //AJAX小類連動屬性 - 必填屬性
        $("#level2").on("change", function(){

            //alert($("#subStationId").val());
            $("#requiredattr").find("option:selected").text("");
            $("#requiredattr").empty();
            var attrs;
            $.ajax({
                type: 'POST',
                async: false,  //使用同步
                url: "/mng/Product/list/yahooshoppingscm/ajax_Get_attributes.ashx",
                data: 'catItemId=' + $("#catItemId").val()+'&attrclass=required&level1='+$("#level1").val()+'&level2='+$("#level2").val()  ,
                dataType: "text",
                success: function (info) {
                    
                    attrs = info
                    console.log(info)
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    //var message = '轉資料時發生錯誤';
                    //alert(message);    //提示視窗
                    alert('此小類無必填屬性確定選取?')
                }
            })

            $("#requiredattr").html(attrs);
            
            
        });

        //AJAX小類連動屬性 - 取小類ID屬性
        $("#catItemId").on("change", function(){

            //alert($("#subStationId").val());
            $("#requiredattr").find("option:selected").text("");
            $("#requiredattr").empty();
            var attrs;
            $.ajax({
                type: 'POST',
                async: false,  //使用同步
                url: "/mng/Product/list/yahooshoppingscm/ajax_Get_attributes.ashx",
                data: 'catItemId=' + $("#catItemId").val()+'&attrclass=struDataAttrClusterId',
                dataType: "text",
                success: function (info) {
                    
                    attrs = info
                    console.log(info)
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    //var message = '轉資料時發生錯誤';
                    //alert(message);    //提示視窗
                    alert('此小類無屬性ID確定選取?')
                }
            })
            
            //alert(attrs);
            $("#struDataAttrClusterId").val(attrs);
            
        });


        //傳遞動態下拉選項數目至Form_CRUD_Save

       function getlengthandsubmit(){

           //alert($("#requiredattr1>select").length)
           //alert($("#requiredattr2>input").length/2)

           $("#attrnoncustomcount").val($("#requiredattr1>select").length);
           $("#attrcustomcount").val($("#requiredattr2>input").length / 2);
           

           //$('#ff').submit();

            };

    </script>
   
</asp:Content>

```

```text
'/////////////////////////////////////////////////////////////////////////////////
' 表單 (新增/修改)
'
' 建檔人員: 阿友
' 建檔日期: 2012-08-01/31
' 修改記錄: 範例--> 日期 記錄人員 簡述
' 關連程式: 
' 呼叫來源: 
'/////////////////////////////////////////////////////////////////////////////////
Imports EC.Library.Security
Imports System.Data

Partial Class mng_product_list_Form
    Inherits System.Web.UI.Page

    Public PrgID As String = ""
    Public prglimit As EC.mng.Limit       '讀取程式的權限
    Public _ID As Integer = 0
    Public tb As New Ls3c_v2_2005.list
    Public ProductNo As String = ""

    '初始清單
    Public yahoolist As New Dictionary(Of String, String)
    Public yahooattr As New Dictionary(Of String, String)

    '初始類別
    Public yahooCategorysubs As String
    Public yahooCategorycats As String
    Public yahooCategorycatstext As String
    Public yahooCategorycatitems As String
    Public contentRatings As String
    '初始屬性
    Public level1 As String = ""
    Public level2 As String = ""
    Public attrnoncustom As String = ""
    Public attrcustom As String = ""
    '屬性ID
    Public struDataAttrClusterId As String = ""
    'model displayname
    Public lv1displayname As String = ""
    Public lv2displayname As String = ""


    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load

        Response.CacheControl = "no-cache"             '避免被 Cache 住
        EC.mng.Login.LoginCheck()                      '未登入則導到登入頁
        prglimit = New EC.mng.Limit(ViewState)         '讀取程式的權限

        PrgID = SQLIJ(Request("PrgID"))                '主選單的MENUID,判斷權限使用.
        _ID = RequestNumeric("ID", RequestActMode.None, RequestMode.SQLInjection)

        '正常讀取頁面

        If Not IsNumeric(_ID) Then _ID = 0

            '取資料
            If _ID > 0 Then   'Modify

                tb = Ls3c_v2_2005.list.Load2012(_ID)
                tb.image = tb.image & ""
                ProductNo = String.Format("SELECT ProductNo FROM list WITH(NOLOCK) WHERE cno='{0}'", _ID)
                ProductNo = EC.DB.ExecuteDataTable(ProductNo).Select().FirstOrDefault.Item("ProductNo").ToString

                '擷取Yahooshoppingscm list新增欄位
                Dim APIlistdtSql = String.Format("SELECT * FROM YahooshoppingSCM_API_list WITH(NOLOCK) WHERE ProductNo='{0}'", ProductNo)
                Dim APIlistdt = EC.DB.ExecuteDataTable(APIlistdtSql)
                If APIlistdt.Rows.Count > 0 Then

                    With yahoolist

                        .Add("applicant", APIlistdt.Select().FirstOrDefault.Item("applicant").ToString())
                        .Add("contentRating", APIlistdt.Select().FirstOrDefault.Item("contentRating").ToString())
                        .Add("videos", APIlistdt.Select().FirstOrDefault.Item("videos").ToString())
                        .Add("images", APIlistdt.Select().FirstOrDefault.Item("images").ToString())
                        .Add("copy", APIlistdt.Select().FirstOrDefault.Item("copy").ToString())
                        .Add("displayName", APIlistdt.Select().FirstOrDefault.Item("displayName").ToString())
                        .Add("shortDescription_1", APIlistdt.Select().FirstOrDefault.Item("shortDescription_1").ToString())
                        .Add("shortDescription_2", APIlistdt.Select().FirstOrDefault.Item("shortDescription_2").ToString())
                        .Add("shortDescription_3", APIlistdt.Select().FirstOrDefault.Item("shortDescription_3").ToString())
                        .Add("shortDescription_4", APIlistdt.Select().FirstOrDefault.Item("shortDescription_4").ToString())
                        .Add("shortDescription_5", APIlistdt.Select().FirstOrDefault.Item("shortDescription_5").ToString())
                        .Add("subStationId", APIlistdt.Select().FirstOrDefault.Item("subStationId").ToString())
                        .Add("catItemId", APIlistdt.Select().FirstOrDefault.Item("catItemId").ToString())

                    End With

                Else

                    With yahoolist

                        .Add("applicant", "")
                        .Add("contentRating", "")
                        .Add("videos", "")
                        .Add("images", "")
                        .Add("copy", "")
                        .Add("displayName", "")
                        .Add("shortDescription_1", "")
                        .Add("shortDescription_2", "")
                        .Add("shortDescription_3", "")
                        .Add("shortDescription_4", "")
                        .Add("shortDescription_5", "")
                        .Add("subStationId", "")
                        .Add("catItemId", "")

                    End With

                End If

            '擷取Yahooshoppingscm attr新增欄位
            Dim APIlistattrdtSql = String.Format("SELECT * FROM YahooshoppingSCM_API_list_attributes WITH(NOLOCK) WHERE ProductNo='{0}'", ProductNo)
            Dim APIlistattrdt = EC.DB.ExecuteDataTable(APIlistattrdtSql)


            '雅虎初始大類 ( 應該在迴圈內判斷並添加 selected )

            Dim yahooCategorysubdt = EC.DB.ExecuteDataTable("SELECT subID,subname FROM YahooshoppingSCM_API_Category WITH(NOLOCK) GROUP BY subID,subname")

            If yahoolist.Item("subStationId") <> "" Or yahoolist.Item("subStationId") <> Nothing Then

                Dim selectsql = String.Format("subId='{0}'", yahoolist.Item("subStationId"))
                yahooCategorysubs += "<option value='" + yahoolist.Item("subStationId") + "'>" + yahooCategorysubdt.Select(selectsql).FirstOrDefault.Item(1).ToString + "</option>"

            Else
                yahooCategorysubs += "<option value=''>未選擇</option>"
            End If

            For num As Integer = 0 To yahooCategorysubdt.Rows.Count - 1 Step 1
                    yahooCategorysubs += "<option value='" + yahooCategorysubdt.Rows.Item(num).Item(0) + "'>" + yahooCategorysubdt.Rows.Item(num).Item(1) + "</option>"
                Next

            '雅虎初始中類 (因雅虎上架不需要中類故不做存取預設值)
            If yahoolist.Item("catItemId") <> "" Or yahoolist.Item("catItemId") <> Nothing Then
                yahooCategorycatstext = "<font style='color:red'>因雅虎上架資料不需存中類，故不記錄中類屬性。</font>"
            End If

            yahooCategorycats += "<option value=''>未選擇</option>"

            '雅虎初始小類 ( 應該在迴圈內判斷並添加 selected )

            Dim yahooCategorycatitemdt = EC.DB.ExecuteDataTable("SELECT catItemId,catItemIdname FROM YahooshoppingSCM_API_Category WITH(NOLOCK) GROUP BY catItemId,catItemIdname")

            If yahoolist.Item("catItemId") <> "" Or yahoolist.Item("catItemId") <> Nothing Then

                Dim selectsql = String.Format("catItemId='{0}'", yahoolist.Item("catItemId"))
                yahooCategorycatitems += "<option value='" + yahoolist.Item("catItemId") + "'>" + yahooCategorycatitemdt.Select(selectsql).FirstOrDefault.Item(1).ToString + "</option>"

            Else
                yahooCategorycatitems += "<option value=''>未選擇</option>"
            End If

            '雅虎初始內容級別

            If yahoolist.Item("contentRating") <> "" Or yahoolist.Item("contentRating") <> Nothing Then

                Dim contentRatingcontent
                Select Case yahoolist.Item("contentRating")
                    Case "G"
                        contentRatingcontent = "G:普級"
                    Case "PG"
                        contentRatingcontent = "PG:保護級"
                    Case "PG12"
                        contentRatingcontent = "PG12:輔導級12歲+"
                    Case "R"
                        contentRatingcontent = ">R:限制級"
                End Select

                contentRatings += String.Format("<option value='{0}'>{1}</option>", yahoolist.Item("contentRating"), contentRatingcontent)
            Else
                contentRatings += "<option value=''>未選擇</option>"
            End If

            contentRatings += "<option value ='G'>G:普級</option><option value='PG'>PG:保護級</option><option value='PG12'>PG12:輔導級12歲+</option><option value='R'>R:限制級</option>"

        End If


        '結構化屬性查詢

        'level 1 屬性

        Dim attrlevel1sql = "SELECT Top 1 * FROM YahooshoppingSCM_API_list_attributes WITH (NOLOCK) WHERE ProductNo ='{0}' AND [level] ='1'"
        attrlevel1sql = String.Format(attrlevel1sql, ProductNo)
        Dim level1dt = EC.DB.ExecuteDataTable(attrlevel1sql)

        If level1dt.Rows.Count > 0 Then
            level1 = level1dt.Select().FirstOrDefault.Item("Attrname").ToString()
        End If

        'level 2 屬性
        Dim attrlevel2sql = "SELECT Top 1 * FROM YahooshoppingSCM_API_list_attributes WITH (NOLOCK) WHERE ProductNo ='{0}' AND [level] ='2'"
        attrlevel2sql = String.Format(attrlevel2sql, ProductNo)
        Dim level2dt = EC.DB.ExecuteDataTable(attrlevel2sql)

        If level2dt.Rows.Count > 0 Then
            level2 = level2dt.Select().FirstOrDefault.Item("Attrname").ToString()
        End If

        '必填非自定義屬性
        Dim attrsql1 = "SELECT * FROM YahooshoppingSCM_API_list_attributes WITH (NOLOCK) WHERE ProductNo ='{0}' AND contenttype = 'attrnoncustom'"
        attrsql1 = String.Format(attrsql1, ProductNo)
        Dim dt = EC.DB.ExecuteDataTable(attrsql1)

        For num As Integer = 0 To dt.Rows.Count - 1 Step 1

            attrnoncustom += "<input style='border: 0' id='attrname{1}' name='attrname{2}' readonly='readonly' value='{0}' required='required'/> : <select id='attrnoncustom{1}' name='attrnoncustom{2}' required='required'>"
            attrnoncustom = String.Format(attrnoncustom, dt.Rows.Item(num).Item("Attrname").ToString(), num, num)

            Dim Attrvalues = dt.Rows.Item(num).Item("Attrvalues").ToString()
            attrnoncustom += "<option value ='" + Attrvalues + "'>" + Attrvalues + "</option></select></br>"

        Next





        '必填自定義屬性
        Dim attrsql2 = "SELECT * FROM YahooshoppingSCM_API_list_attributes WITH (NOLOCK) WHERE ProductNo ='{0}' AND contenttype = 'attrcustom'"
        attrsql2 = String.Format(attrsql2, ProductNo)
        Dim dt2 = EC.DB.ExecuteDataTable(attrsql2)

        For num As Integer = 0 To dt2.Rows.Count - 1 Step 1

            Dim Attrvalues2 = dt2.Rows.Item(num).Item("Attrvalues").ToString()
            attrcustom += "<input style='border: 0' id='textattrname{1}' name='textattrname{2}' readonly='readonly' value='{0}' required='required'/> : <input id='attrcustom{1}' name='attrcustom{2}' value='{3}' required='required' />"
            attrcustom = String.Format(attrcustom, dt2.Rows.Item(num).Item("Attrname").ToString(), num, num, Attrvalues2)
            attrcustom += "</br>"

        Next

        '屬性ID
        Dim struDataAttrClusterIdsql = "SELECT struDataAttrClusterId FROM YahooshoppingSCM_API_list_attributes WITH (NOLOCK) WHERE ProductNo ='{0}'"
        struDataAttrClusterIdsql = String.Format(struDataAttrClusterIdsql, ProductNo)
        Dim struDataAttrClusterIddt = EC.DB.ExecuteDataTable(struDataAttrClusterIdsql)
        If struDataAttrClusterIddt.Rows.Count > 0 Then
            struDataAttrClusterId = struDataAttrClusterIddt.Select().FirstOrDefault.Item("struDataAttrClusterId").ToString
        End If

        '強制只有一組 model 所以 依照 level 1 與 2  必須再補兩組 lv1displayname lv2displayname
        Dim lv1displaynamesql = "SELECT TOP 1 displayName FROM YahooshoppingSCM_API_list_attributes WITH (NOLOCK) WHERE ProductNo ='{0}' AND level ='1'"
        lv1displaynamesql = String.Format(lv1displaynamesql, ProductNo)
        Dim lv1displaynamedt = EC.DB.ExecuteDataTable(lv1displaynamesql)
        If lv1displaynamedt.Rows.Count > 0 Then
            lv1displayname = lv1displaynamedt.Select().FirstOrDefault.Item("displayName").ToString
        End If

        Dim lv2displaynamesql = "SELECT TOP 1 displayName FROM YahooshoppingSCM_API_list_attributes WITH (NOLOCK) WHERE ProductNo ='{0}' AND level ='2'"
        lv2displaynamesql = String.Format(lv2displaynamesql, ProductNo)
        Dim lv2displaynamedt = EC.DB.ExecuteDataTable(lv2displaynamesql)
        If lv2displaynamedt.Rows.Count > 0 Then
            lv2displayname = lv2displaynamedt.Select().FirstOrDefault.Item("displayName").ToString
        End If



    End Sub

End Class

```

```text
'/////////////////////////////////////////////////////////////////////////////////
' 儲存選單資料 (新增/修改/刪除)
'
' 建檔人員: 阿友
' 建檔日期: 2012-08-01
' 修改記錄: 範例--> 日期 記錄人員 簡述
' 關連程式:
' 呼叫來源: 
'/////////////////////////////////////////////////////////////////////////////////
Imports System.Data
Imports EC.Library.Security

Partial Class mng_product_list_Form_Save
    Inherits System.Web.UI.Page

    Public prglimit As EC.mng.Limit       '讀取程式的權限

    '讀取程式的權限



    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load

        Response.CacheControl = "no-cache"             '避免被 Cache 住
        EC.mng.Login.LoginCheck()                      '未登入則導到登入頁

        Dim action As String = RequestString("action", RequestActMode.None, RequestMode.XSS)    '空值 or del

        Dim errStatus As String = "ok"
        Dim errMessage As String = "儲存完成"

        prglimit = EC.mng.Limit.CheckLimit(ViewState)    '檢查使用者權限
        If prglimit.errStatus = "error" Then   '權限不符
            errStatus = prglimit.errStatus
            errMessage = prglimit.errMessage
        Else  '儲存

            '雅虎購物欄位 儲存至 YahooshoppingSCM_API_list 一筆ProductNo一筆資料
            Dim ProductNo = RequestString("ProductNo", RequestActMode.None, RequestMode.XSS) & ""
            Dim applicant = RequestString("applicant", RequestActMode.None, RequestMode.XSS) & ""
            Dim contentRating = RequestString("contentRating", RequestActMode.None, RequestMode.XSS) & ""
            Dim videos = ""
            Dim images = ""
            Dim copy = ""
            Dim displayName = RequestString("displayName", RequestActMode.None, RequestMode.XSS) & ""
            Dim shortDescription_1 = RequestString("shortDescription_1", RequestActMode.None, RequestMode.XSS) & ""
            Dim shortDescription_2 = RequestString("shortDescription_2", RequestActMode.None, RequestMode.XSS) & ""
            Dim shortDescription_3 = RequestString("shortDescription_3", RequestActMode.None, RequestMode.XSS) & ""
            Dim shortDescription_4 = RequestString("shortDescription_4", RequestActMode.None, RequestMode.XSS) & ""
            Dim shortDescription_5 = RequestString("shortDescription_5", RequestActMode.None, RequestMode.XSS) & ""

            Dim subStationId = RequestString("subStationId", RequestActMode.None, RequestMode.XSS) & ""
            Dim catItemId = RequestString("catItemId", RequestActMode.None, RequestMode.XSS) & ""


            Dim sqlcount = "SELECT COUNT(*) FROM YahooshoppingSCM_API_list WITH(NOLOCK) WHERE ProductNo='{0}'"
            sqlcount = String.Format(sqlcount, ProductNo)
            If EC.DB.ExecuteScalar(sqlcount) > 0 Then 'UPDATE

                Dim sqlupdate = "UPDATE YahooshoppingSCM_API_list SET ProductNo='{0}',applicant='{1}',contentRating='{2}',videos='{3}',images='{4}',copy='{5}',displayName='{6}',shortDescription_1='{7}',shortDescription_2='{8}',shortDescription_3='{9}',shortDescription_4='{10}',shortDescription_5='{11}',subStationId='{12}',catItemId='{13}' WHERE ProductNo='{1}'"
                sqlupdate = String.Format(sqlupdate, ProductNo, applicant, contentRating, videos, images, copy, displayName, shortDescription_1, shortDescription_2, shortDescription_3, shortDescription_4, shortDescription_5, subStationId, catItemId)
                EC.DB.ExecuteScalar(sqlupdate)

            Else 'INSERT

                Dim sqlupdate = "INSERT INTO YahooshoppingSCM_API_list (ProductNo,applicant,contentRating,videos,images,copy,displayName,shortDescription_1,shortDescription_2,shortDescription_3,shortDescription_4,shortDescription_5, subStationId, catItemId) VALUES('{0}','{1}','{2}','{3}','{4}','{5}','{6}','{7}','{8}','{9}','{10}','{11}','{12}','{13}')"
                sqlupdate = String.Format(sqlupdate, ProductNo, applicant, contentRating, videos, images, copy, displayName, shortDescription_1, shortDescription_2, shortDescription_3, shortDescription_4, shortDescription_5, subStationId, catItemId)
                EC.DB.ExecuteScalar(sqlupdate)

            End If

            '雅虎購物屬性 儲存至 YahooshoppingSCM_API_list_attributes

            '屬性ID

            Dim struDataAttrClusterId = RequestString("struDataAttrClusterId", RequestActMode.None, RequestMode.XSS)

            'select數量    attrname0，attrnoncustom0
            Dim attrnoncustomcount = RequestString("attrnoncustomcount", RequestActMode.None, RequestMode.XSS)

            Dim attrnoncustomlist As New List(Of String)

            For num As Integer = 0 To attrnoncustomcount - 1 Step 1

                With attrnoncustomlist
                    Dim requestname = String.Format("attrname{0}", num)
                    Dim attrname = RequestString(requestname, RequestActMode.None, RequestMode.XSS)
                    Dim requestname1 = String.Format("attrnoncustom{0}", num)
                    Dim attrnoncustom = RequestString(requestname1, RequestActMode.None, RequestMode.XSS)

                    attrnoncustomlist.Add(attrname)
                    attrnoncustomlist.Add(attrnoncustom)

                End With

            Next

            'input數量      textattrname0，attrcustom0
            Dim attrcustomcount = RequestString("attrcustomcount", RequestActMode.None, RequestMode.XSS)

            Dim attrcustomlist As New List(Of String)

            For num As Integer = 0 To attrcustomcount - 1 Step 1

                With attrcustomlist
                    Dim requestname = String.Format("textattrname{0}", num)
                    Dim attrname = RequestString(requestname, RequestActMode.None, RequestMode.XSS)
                    Dim requestname1 = String.Format("attrcustom{0}", num)
                    Dim attrnoncustom = RequestString(requestname1, RequestActMode.None, RequestMode.XSS)

                    attrcustomlist.Add(attrname)
                    attrcustomlist.Add(attrnoncustom)

                End With

            Next

            If EC.DB.ExecuteScalar(sqlcount) > 0 Then

                'INSERT 'UPDATE 都須直接刪除再儲存 避免大中小類不同而衝突
                Dim sqldelet = "DELETE FROM YahooshoppingSCM_API_list_attributes WHERE ProductNo='{0}'"
                sqldelet = String.Format(sqldelet, ProductNo)
                EC.DB.ExecuteScalar(sqldelet)

                '非自定義屬性
                For num As Integer = 0 To attrnoncustomcount - 1 Step 2

                    Dim Attrname = attrnoncustomlist.Item(num)
                    Dim Attrvalues = attrnoncustomlist.Item(num + 1)
                    Dim sqlupdate = "INSERT INTO YahooshoppingSCM_API_list_attributes (ProductNo,struDataAttrClusterId,Attrname,Attrvalues,contenttype) VALUES('{0}','{1}','{2}','{3}','{4}')"
                    sqlupdate = String.Format(sqlupdate, ProductNo, struDataAttrClusterId, Attrname, Attrvalues, "attrnoncustom")
                    EC.DB.ExecuteScalar(sqlupdate)

                Next

                '自定義屬性

                For num As Integer = 0 To attrcustomcount - 1 Step 2

                    Dim Attrname = attrcustomlist.Item(num)
                    Dim Attrvalues = attrcustomlist.Item(num + 1)
                    Dim sqlupdate = "INSERT INTO YahooshoppingSCM_API_list_attributes (ProductNo,struDataAttrClusterId,Attrname,Attrvalues,contenttype) VALUES('{0}','{1}','{2}','{3}','{4}')"
                    sqlupdate = String.Format(sqlupdate, ProductNo, struDataAttrClusterId, Attrname, Attrvalues, "attrcustom")
                    EC.DB.ExecuteScalar(sqlupdate)

                Next

            End If

            '初始值為0 需將所有 level歸零後重新 UPDATE level & displayname

            Dim level1 = RequestString("level1", RequestActMode.None, RequestMode.XSS)
            Dim level2 = RequestString("level2", RequestActMode.None, RequestMode.XSS)
            Dim lv1displayname = RequestString("lv1displayname", RequestActMode.None, RequestMode.XSS)
            Dim lv2displayname = RequestString("lv2displayname", RequestActMode.None, RequestMode.XSS)

            Dim sqlcount3 = "SELECT COUNT(*) FROM YahooshoppingSCM_API_list_attributes WITH(NOLOCK) WHERE ProductNo='{0}'"
            sqlcount3 = String.Format(sqlcount3, ProductNo)
            If EC.DB.ExecuteScalar(sqlcount3) > 0 Then 'UPDATE

                Dim sqlupdate = "UPDATE YahooshoppingSCM_API_list_attributes SET [level]='{0}',displayName = NULL WHERE ProductNo='{1}'"
                sqlupdate = String.Format(sqlupdate, 0, ProductNo)
                EC.DB.ExecuteScalar(sqlupdate)

                'level 1
                Dim sqlupdate1 = "UPDATE YahooshoppingSCM_API_list_attributes SET [level]='1',displayName ='{0}' WHERE ProductNo='{1}' AND Attrname='{2}'"
                sqlupdate1 = String.Format(sqlupdate1, lv1displayname, ProductNo, level1)
                EC.DB.ExecuteScalar(sqlupdate1)
                'level 2
                Dim sqlupdate2 = "UPDATE YahooshoppingSCM_API_list_attributes SET [level]='2',displayName ='{0}' WHERE ProductNo='{1}' AND Attrname='{2}'"
                sqlupdate2 = String.Format(sqlupdate2, lv2displayname, ProductNo, level2)
                EC.DB.ExecuteScalar(sqlupdate2)

            End If

        End If

            Response.Write("[{status: '" & errStatus & "', message:'" & errMessage & "'}]")

    End Sub

End Class

```

